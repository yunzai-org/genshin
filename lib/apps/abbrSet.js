import*as e from"yunzai";import{Plugin as t}from"yunzai";import i from"node:fs";import{GSCfg as s}from"yunzai-mys";import r from"yaml";import a from"lodash";class n extends t{constructor(){super({priority:600,rule:[{reg:"^#(星铁)?(设置|配置)(.*)(别名|昵称)$",fnc:"abbr"},{reg:"^#(星铁)?删除(别名|昵称)(.*)$",fnc:"delAbbr"},{reg:"^#(星铁)?(.*)(别名|昵称)$",fnc:"abbrList"}]})}isSr=!1;file="./plugins/genshin/config/role.name.yaml";async init(){i.existsSync(this.file)||i.writeFileSync(this.file,"神里绫华:\n  - 龟龟\n  - 小乌龟")}async abbr(){if(!await this.checkAuth())return;let e=s.getRole(this.e.msg,"#|星铁|设置|配置|别名|昵称",this.e.isSr);if(!e)return!1;this.e.role=e,this.isSr=this.e.isSr,this.setContext("setAbbr"),await this.reply(`请发送${e.alias}别名，多个用空格隔开`)}async checkAuth(){if(!this.e.isGroup&&!this.e.isMaster)return await this.reply("禁止私聊设置角色别名"),!1;let e=s.getConfig("mys","set").abbrSetAuth;if(0===e)return!0;if(this.e.isMaster)return!0;if(1==e){if(!this.e.bot.gml.has(this.e.group_id))return!1;if(!this.e.bot.gml.get(this.e.group_id).get(this.e.user_id))return!1;if(!this.e.member.is_admin)return this.e.reply("暂无权限，只有管理员才能操作"),!1}return!0}async setAbbr(){if(!this.e.msg||this.e.at||this.e.img)return void await this.reply("设置错误：请发送正确内容");let{setAbbr:e={}}=this.getContext();this.finish("setAbbr");let t=e.role,i=this.e.msg.split(" "),r=s.getConfig("role","name");r[t.name]||(r[t.name]=[]);let a=[];for(let e of i)e=e.replace(/#|星铁|设置|配置|别名|昵称/g,""),e&&(r[t.name].includes(e)||s.roleNameToID(e,this.isSr)||(r[t.name].push(e),a.push(e)));a.length<=0?await this.reply("设置失败：别名错误或已存在"):(this.save(r),s[this.isSr?"sr_nameID":"nameID"]=!1,await this.reply(`设置别名成功：${a.join("、")}`))}save(e){e=r.stringify(e),i.writeFileSync(this.file,e)}async delAbbr(){let e=s.getRole(this.e.msg,"#|星铁|删除|别名|昵称",this.e.isSr);if(!e)return!1;let t=s.getConfig("role","name");if(!t[e.name])return await this.reply("默认别名设置，不能删除！"),!0;t[e.name]=t[e.name].filter((t=>t!=e.alias&&t)),this.save(t),await this.reply(`设置${e.name}别名成功：${e.alias}`)}async abbrList(){let t=s.getRole(this.e.msg,"#|星铁|别名|昵称",this.e.isSr);if(!t)return!1;let i=s.getdefSet("role",this.e.isSr?"sr_name":"name")[t.roleId],r=s.getConfig("role","name")[t.name]??[],n=a.uniq([...i,...r]),h=[];for(let e in n){let t=Number(e)+1;h.push(`${t}.${n[e]}`)}h=await e.makeForwardMsg(this.e,[h.join("\n")],`${t.name}别名，${n.length}个`),await this.e.reply(h)}}export{n as abbrSet};
