import*as t from"yunzai";import{plugin as e}from"yunzai";import i from"node-fetch";import{MysInfo as a}from"yunzai-mys";class r extends e{constructor(){super({priority:1e3,rule:[{reg:/^(#|\*)?(原神|星铁|崩铁|崩三|崩坏三|崩坏3)?(直播|前瞻)?兑换码$/,fnc:"getCode"},{reg:"^#(兑换码使用|cdk-u).+",fnc:"useCode"}]})}async getCode(){let e=this.e.msg.match(/^(#|\*)?(原神|星铁|崩铁|崩三|崩坏三|崩坏3)?(直播|前瞻)?兑换码$/);this.uid="75276550",("*"==e[1]||["星铁","崩铁"].includes(e[2]))&&(this.uid="80823548"),["崩三","崩坏三","崩坏3"].includes(e[2])&&(this.uid="73565430"),this.now=parseInt(Date.now()/1e3);let i=await this.getActId();if(!i)return logger.info("[兑换码] 未获取到actId"),!0;this.actId=i;let a=await this.getData("index");if(!a||!a.data)return!0;if(null===a.data)return await this.reply(`错误：\n${a.message}`);let r=a.data.live,s=r.title;if(this.code_ver=r.code_ver,r.remain>0)return await this.reply(`暂无${s}直播兑换码`,!0);let o=await this.getData("code");if(!o||!o.data?.code_list)return logger.info("[兑换码] 未获取到兑换码"),!0;let d=[];for(let t of o.data.code_list)t.code&&d.push([t.code,segment.button([{text:"兑换",callback:`#兑换码使用${t.code}`}])]);let n=[`兑换码过期时间: \n${this.deadline}`,...d];n=await t.makeForwardMsg(this.e,n,`${s}-直播兑换码`),await this.reply(n)}async getData(t){let e,a={index:"https://api-takumi.mihoyo.com/event/miyolive/index",code:`https://api-takumi-static.mihoyo.com/event/miyolive/refreshCode?version=${this.code_ver}&time=${this.now}`,actId:`https://bbs-api.mihoyo.com/painter/api/user_instant/list?offset=0&size=20&uid=${this.uid}`};try{e=await i(a[t],{method:"get",headers:{"x-rpc-act_id":this.actId}})}catch(t){return logger.error(t.toString()),!1}if(!e.ok)return logger.error(`[兑换码接口错误][${t}] ${e.status} ${e.statusText}`),!1;return await e.json()}async getActId(){let t=await this.getData("actId");if(t.error||0!==t.retcode)return"";for(const e of t.data.list){let t;try{t=e.post.post}catch(t){logger.error("活动数据获取异常"),logger.error(t)}if(!t)continue;let i=new Date(1e3*t.created_at);"80823548"==this.uid?(i.setDate(i.getDate()+1),this.deadline=`${i.getFullYear()}-${i.getMonth()+1}-${i.getDate()} 23:59:59`):"73565430"==this.uid?(i.setDate(i.getDate()+5),this.deadline=`${i.getFullYear()}-${i.getMonth()+1}-${i.getDate()} 12:00:00`):(i.setDate(i.getDate()+3),this.deadline=`${i.getFullYear()}-${i.getMonth()+1}-${i.getDate()} 12:00:00`);let a=t.structured_content.match(/{\"link\":\"https:\/\/webstatic.mihoyo.com\/bbs\/event\/live\/index.html\?act_id=(.*?)\\/);if(a)return a[1]}}async useCode(){const t=this.e.msg.replace(/#(兑换码使用|cdk-u)/,"").trim(),e=await a.get(this.e,"useCdk",{cdk:t});e&&this.e.reply(`${e.data.msg}`)}}export{r as exchange};
