import{plugin as a}from"yunzai";import e from"../model/gachaData.js";import t from"node:fs";import n from"lodash";class i extends a{constructor(){super({priority:100,rule:[{reg:"^#*(10|[武器池常驻]*[十]+|抽|单)[连抽卡奖][123武器池常驻]*$",fnc:"gacha"},{reg:"(^#*定轨|^#定轨(.*))$",fnc:"weaponBing"}]})}async gacha(){if(this.GachaData=await e.init(this.e),this.checkLimit())return;let a=await this.GachaData.run();await this.renderImg("genshin","html/gacha/gacha-trial",a,{recallMsg:!(a.nowFive>=1||a.nowFour>=4)&&this.GachaData.set.delMsg})}checkLimit(){if(this.e.isMaster)return!1;let{user:a}=this.GachaData,{num:e,weaponNum:t}=a.today,i=e;if("weapon"==this.GachaData.type&&(i=t),1==this.GachaData.set.LimitSeparate){if(i<10*this.GachaData.set.count)return!1}else if(e+t<10*this.GachaData.set.count)return!1;let s=n.truncate(this.e.sender.card,{length:8})+"\n";return a.today.star.length>0?(s+="今日五星：",a.today.star.length>=4?s+=`${a.today.star.length}个`:(a.today.star.forEach((a=>{s+=`${a.name}(${a.num})\n`})),s=n.trim(s,"\n")),a.week.num>=2&&(s+=`\n本周：${a.week.num}个五星`)):s+=`今日已抽，累计${i}抽无五星`,this.reply(s,!1,{recallMsg:this.GachaData.set.delMsg}),!0}async weaponBing(){let a=await e.init(this.e),{NowPool:t,user:n,msg:i=""}=a;n.weapon.type>=2?(n.weapon.type=0,n.weapon.bingWeapon="",i="\n定轨已取消"):(n.weapon.type++,n.weapon.bingWeapon=t.weapon5[n.weapon.type-1],i=[],t.weapon5.forEach(((a,e)=>{n.weapon.type-1==e?i.push(`[√] ${t.weapon5[e]}`):i.push(`[  ] ${t.weapon5[e]}`)})),i="定轨成功\n"+i.join("\n")),n.weapon.lifeNum=0,a.user=n,a.saveUser(),this.reply(i,!1,{at:this.e.user_id})}async init(){let a="./plugins/genshin/config/gacha.set.yaml";t.existsSync(a)||t.copyFileSync("./plugins/genshin/defSet/gacha/set.yaml",a)}}export{i as gacha};
