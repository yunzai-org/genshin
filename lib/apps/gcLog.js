import{plugin as e}from"yunzai";import t from"node:fs";import s from"../model/gachaLog.js";import i from"../model/exportLog.js";import l from"../model/logCount.js";const r=process.cwd()+"/plugins/genshin";class a extends e{constructor(){super({priority:300,rule:[{reg:"(.*)authkey=(.*)",fnc:"logUrl"},{reg:"^#json文件导入记录$",fnc:"logJson"},{reg:"^#?(原神|星铁)?(全部)?(抽卡|抽奖|角色|武器|集录|常驻|up|新手|光锥|全部)池*(记录|祈愿|分析)$",fnc:"getLog"},{reg:"^#?(原神|星铁)?(强制)?导出记录(json)?$",fnc:"exportLog"},{reg:"^#?(记录帮助|抽卡帮助)$",fnc:"help"},{reg:"^#?(安卓|苹果|电脑|pc|ios)帮助$",fnc:"helpPort"},{reg:"^#?(原神|星铁)?(抽卡|抽奖|角色|武器|集录|常驻|up|新手|光锥)池*统计$",fnc:"logCount"}]}),this.androidUrl="https://docs.qq.com/doc/DUWpYaXlvSklmVXlX",Object.defineProperty(this,"button",{get(){return this.prefix=this.e?.isSr?"*":"#",segment.button([{text:"角色记录",callback:`${this.prefix}角色记录`},{text:"角色统计",callback:`${this.prefix}角色统计`}],[{text:"武器记录",callback:`${this.prefix}武器记录`},{text:"武器统计",callback:`${this.prefix}武器统计`}],[{text:"集录记录",callback:`${this.prefix}集录记录`},{text:"集录统计",callback:`${this.prefix}集录统计`}],[{text:"常驻记录",callback:`${this.prefix}常驻记录`},{text:"常驻统计",callback:`${this.prefix}常驻统计`}])}})}async init(){let e=["./data/gachaJson","./data/srJson","./temp/html/StarRail","./temp/uigf"];for(let s of e)t.existsSync(s)||t.mkdirSync(s)}accept(){if(this.e.file){let e=this.e.file?.name;if(/(.*)([1-9]|18)[0-9]{8}(.*).json/gi.test(e))return this.e.msg="#json文件导入记录",!0}if(this.e.msg&&/^#?(角色|武器)统计$/g.test(this.e.msg))return this.e.msg=this.e.msg.replace("统计","池统计"),!0}async logUrl(){let e=await new s(this.e).logUrl();e&&(await this.renderImg("genshin","html/gacha/gacha-log",e),this.e.isGroup&&this.e.reply("已收到链接，请撤回",!1,{at:!0}))}async getLog(){this.e.isAll=!!this.e.msg.includes("全部");let e=await new s(this.e).getLogData();if(!e)return;let t="html/gacha/gacha-log";this.e.isAll&&(t="html/gacha/gacha-all-log"),this.reply([await this.renderImg("genshin",t,e,{retType:"base64"}),this.button])}exportLog(){return this.e.isGroup&&!this.e.msg.includes("强制")?this.reply("建议私聊导出，若你确认要在此导出，请发送【#强制导出记录】",!1,{at:!0}):new i(this.e).exportJson()}async logJson(){if(!this.e.file)return this.e.reply("请发送Json文件");await new i(this.e).logJson(),this.e.isGroup&&this.e.reply("已收到文件，请撤回",!1,{at:!0})}help(){this.e.reply([segment.image(`file://${r}/resources/logHelp/记录帮助.png`),segment.button([{text:"电脑",callback:"#电脑帮助"},{text:"安卓",callback:"#安卓帮助"},{text:"苹果",callback:"#苹果帮助"}])])}helpPort(){let e=this.e.msg.replace(/#|帮助/g,"");["电脑","pc"].includes(e)?this.e.reply(segment.image(`file://${r}/resources/logHelp/记录帮助-电脑.png`)):["安卓"].includes(e)?this.e.reply(`安卓抽卡记录获取教程：${this.androidUrl}`):["苹果","ios"].includes(e)&&this.e.reply(segment.image(`file://${r}/resources/logHelp/记录帮助-苹果.png`))}async logCount(){let e=await new l(this.e).count();e&&this.reply([await this.renderImg("genshin","html/gacha/log-count",e,{retType:"base64"}),this.button])}}export{a as gcLog};
