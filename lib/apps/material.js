import{Plugin as t,downFile as e}from"yunzai";import{gsCfg as i}from"yunzai-mys";import s from"node:fs";import a from"node-fetch";class r extends t{constructor(){super({priority:500,rule:[{reg:"^#?(星铁)?(.*)(突破|材料|素材|培养)$",fnc:"material"}]})}path="./temp/material/gs/友人A";pathOther="./temp/material/gs/other";srPath="./temp/material/sr/小橙子啊";srPathOther="./temp/material/sr/other";url="https://bbs-api.mihoyo.com/post/wapi/getPostFullInCollection?&gids=2&order_type=2&collection_id=";collection_id=[428421,1164644,1362644];srCollection_id=[1998643,2146693,2279356];special=["雷电将军","珊瑚宫心海","菲谢尔","托马","八重神子","九条裟罗","辛焱","神里绫华"];oss="?x-oss-process=image//resize,s_1000/quality,q_80/auto-orient,0/interlace,1/format,jpg";async init(){for(let t of["./temp","./temp/material","./temp/material/gs","./temp/material/sr",this.path,this.pathOther,this.srPath,this.srPathOther])s.existsSync(t)||s.mkdirSync(t)}async material(){let t=this.e.msg.includes("更新"),e=i.getRole(this.e.msg,"星铁|突破|材料|素材|更新");if(!e)return!1;if(["10000005","10000007","20000000","8003","8001"].includes(String(e.roleId)))return void await this.e.reply("暂无主角素材");let a=this.e.msg.includes("星铁")?"sr":"";if(this.imgPath=`${this[a+"Path"]}/${e.name}.jpg`,!s.existsSync(this.imgPath)||t){if(await this["getImg"+(a?"Sr":"")](e.name))return await this.e.reply(segment.image(`file://${this.imgPath}`));if(this.imgPath=`${this[a+"PathOther"]}/${e.name}.jpg`,!s.existsSync(this.imgPath)||t)return await this["getImg"+(a?"OtherSr":"Other")](e.name)||await this["getImg"+(a?"Other2Sr":"Other2")](e.name)?await this.e.reply(segment.image(`file://${this.imgPath}`)):void 0;await this.e.reply(segment.image(`file://${this.imgPath}`))}else await this.e.reply(segment.image(`file://${this.imgPath}`))}async getImg(t){this.imgPath=`${this.path}/${t}.jpg`;let i,s=await this.getData(this.collection_id[0]);if(!s||0!==s.retcode)return await this.e.reply("暂无素材数据，请稍后再试"),logger.error(`米游社接口报错：${s.message||"未知错误"}}`),!1;for(let e of s.data.posts)if(e.post.subject.includes(t)){i=e.image_list[1].url,this.special.includes(t)&&(i=e.image_list[2].url);break}return!!i&&(logger.mark(`${this.e.logFnc} 下载${t}素材图`),!!await e(i+this.oss,this.imgPath)&&(logger.mark(`${this.e.logFnc} 下载${t}素材成功`),!0))}async getImgOther(t){this.imgPath=`${this.pathOther}/${t}.jpg`;let i,s=await this.getData(this.collection_id[1]);if(!s||0!==s.retcode)return await this.e.reply("暂无素材数据，请稍后再试"),logger.error(`米游社接口报错：${s.message||"未知错误"}}`),!1;for(let e of s.data.posts)if(e.post.subject.includes(t)){i=e.image_list[0].url;break}return!!i&&(logger.mark(`${this.e.logFnc} 下载${t}素材图`),!!await e(i+this.oss,this.imgPath)&&(logger.mark(`${this.e.logFnc} 下载${t}素材成功`),!0))}async getImgOther2(t){this.imgPath=`${this.pathOther}/${t}.jpg`;let i,s=await this.getData(this.collection_id[2]);if(!s||0!==s.retcode)return await this.e.reply("暂无素材数据，请稍后再试"),logger.error(`米游社接口报错：${s.message||"未知错误"}}`),!1;for(let e of s.data.posts)if(e.post.subject.includes(t)){i=e.image_list[2].url;break}return!!i&&(logger.mark(`${this.e.logFnc} 下载${t}素材图`),!!await e(i+this.oss,this.imgPath)&&(logger.mark(`${this.e.logFnc} 下载${t}素材成功`),!0))}async getImgSr(t){this.imgPath=`${this.srPath}/${t}.jpg`;let i,s=await this.getData(this.srCollection_id[0]);if(!s||0!==s.retcode)return await this.e.reply("暂无素材数据，请稍后再试"),logger.error(`米游社接口报错：${s.message||"未知错误"}}`),!1;for(let e of s.data.posts)if(e.post.subject.includes(t)){i=e.post.images[2];break}return!!i&&(logger.mark(`${this.e.logFnc} 下载${t}素材图`),!!await e(i+this.oss,this.imgPath)&&(logger.mark(`${this.e.logFnc} 下载${t}素材成功`),!0))}async getImgOtherSr(t){this.imgPath=`${this.srPathOther}/${t}.jpg`;let i,s=await this.getData(this.srCollection_id[1]);if(!s||0!==s.retcode)return await this.e.reply("暂无素材数据，请稍后再试"),logger.error(`米游社接口报错：${s.message||"未知错误"}}`),!1;for(let e of s.data.posts)if(e.post.subject.includes(t)){i=e.post.images[0];break}return!!i&&(logger.mark(`${this.e.logFnc} 下载${t}素材图`),!!await e(i+this.oss,this.imgPath)&&(logger.mark(`${this.e.logFnc} 下载${t}素材成功`),!0))}async getImgOther2Sr(t){this.imgPath=`${this.srPathOther}/${t}.jpg`;let i,s=await this.getData(this.srCollection_id[2]);if(!s||0!==s.retcode)return await this.e.reply("暂无素材数据，请稍后再试"),logger.error(`米游社接口报错：${s.message||"未知错误"}}`),!1;for(let e of s.data.posts)if(e.post.subject.includes(t)){i=e.image_list[0].url;break}return!!i&&(logger.mark(`${this.e.logFnc} 下载${t}素材图`),!!await e(i+this.oss,this.imgPath)&&(logger.mark(`${this.e.logFnc} 下载${t}素材成功`),!0))}async getData(t){let e=await a(this.url+t,{method:"get"});if(!e.ok)return!1;return await e.json()}}export{r as material};
