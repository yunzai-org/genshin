import{plugin as s}from"yunzai";import e from"../model/mysNews.js";import i from"node:fs";import t from"lodash";import{gsCfg as r}from"yunzai-mys";import h from"yaml";r.cpCfg("mys","pushNews");class a extends s{constructor(s){super({priority:7e3,rule:[{reg:"^#*(官方|星铁|原神|崩坏三|崩三|绝区零|崩坏二|崩二|崩坏学园二|未定|未定事件簿)?(公告|资讯|活动)(列表|[0-9])*$",fnc:"news"},{reg:"^(#米游社|#mys)(.*)",fnc:"mysSearch"},{reg:"(.*)(bbs.mihoyo.com|miyoushe.com)/ys(.*)/article(.*)",fnc:"mysUrl"},{reg:"^#(原(神|石)|星(铁|琼))?(预估|盘点)$",fnc:"mysEstimate"},{reg:"^#*(星铁|原神|崩坏三|崩三|绝区零|崩坏二|崩二|崩坏学园二|未定|未定事件簿)?(开启|关闭)(公告|资讯)推送$",fnc:"setPush"},{reg:"^#(星铁|原神|崩坏三|崩三|绝区零|崩坏二|崩二|崩坏学园二|未定|未定事件簿)?推送(公告|资讯)$",permission:"master",fnc:"mysNewsTask"},{reg:"^#(星铁|原神)(开启|关闭)到期活动(预警)?(推送)?$",fnc:"setActivityPush"}]}),this.task={cron:r.getConfig("mys","pushNews").pushTime,name:"米游社公告推送任务",fnc:()=>this.mysNewsTask(),log:!1}}file="./plugins/genshin/config/mys.pushNews.yaml";async init(){i.existsSync(this.file)||i.copyFileSync("./plugins/genshin/defSet/mys/pushNews.yaml",this.file)}async news(){let s=this.gids(),i=await new e(this.e).getNews(s);i&&await this.reply(i)}async mysNewsTask(){let s=new e(this.e);await s.ActivityPush(),await s.mysNewsTask()}async setActivityPush(){if(!this.e.isGroup)return void await this.reply("推送请在群聊中设置");if(!this.e.member?.is_admin&&!this.e.isMaster)return await this.reply("暂无权限，只有管理员才能操作",!0),!0;let s,e;this.e.msg.includes("星铁")?(s="srActivityPush",e="星铁"):(s="gsActivityPush",e="原神");let a,n=r.getConfig("mys","pushNews");n[s]||(n[s]={}),Array.isArray(n[s][this.e.self_id])||(n[s][this.e.self_id]=[]);let l=`${e}活动到期预警推送已`;this.e.msg.includes("开启")?(a="开启",n[s][this.e.self_id].push(this.e.group_id),n[s][this.e.self_id]=t.uniq(n[s][this.e.self_id]),l+=`${a}\n如有即将到期的活动将自动推送至此`):(a="关闭",l+=a,n[s][this.e.self_id]=t.difference(n[s][this.e.self_id],[this.e.group_id]),t.isEmpty(n[s][this.e.self_id])&&delete n[s][this.e.self_id]);let m=h.stringify(n);i.writeFileSync(this.file,m,"utf8"),logger.mark(`${this.e.logFnc} ${a}${e}活动到期预警：${this.e.group_id}`),await this.reply(l)}async mysSearch(){if(/签到/g.test(this.e.msg))return!1;let s=await new e(this.e).mysSearch();s&&await this.reply(s)}async mysUrl(){let s=await new e(this.e).mysUrl();s&&await this.reply(s)}async mysEstimate(){let s=["版本原石",218945821];/星(琼|铁)/.test(this.e.msg)&&(s=["可获取星琼",73779489]);let i=await new e(this.e).mysEstimate(...s);i&&await this.reply(i)}async setPush(){if(!this.e.isGroup)return void await this.reply("推送请在群聊中设置");if(!this.e.member?.is_admin&&!this.e.isMaster)return await this.reply("暂无权限，只有管理员才能操作",!0),!0;let s,a=r.getConfig("mys","pushNews"),n=this.gids(),l=1==n?"bbb":2==n?"gs":3==n?"bb":4==n?"wd":6==n?"sr":"zzz",m=`${l}announceGroup`,y="公告";this.e.msg.includes("资讯")&&(m=`${l}infoGroup`,y="资讯");let c=`${await new e(this.e).game(n)}${y}推送已`;Array.isArray(a[m][this.e.self_id])||(a[m][this.e.self_id]=[]),this.e.msg.includes("开启")?(s="开启",a[m][this.e.self_id].push(this.e.group_id),a[m][this.e.self_id]=t.uniq(a[m][this.e.self_id]),c+=`${s}\n如有最新${y}将自动推送至此`):(s="关闭",c+=`${s}`,a[m][this.e.self_id]=t.difference(a[m][this.e.self_id],[this.e.group_id]),t.isEmpty(a[m][this.e.self_id])&&delete a[m][this.e.self_id]);let f=h.stringify(a);i.writeFileSync(this.file,f,"utf8"),logger.mark(`${this.e.logFnc} ${s}${y}推送：${this.e.group_id}`),await this.reply(c)}gids(){switch(this.e.msg.replace(/[#公告资讯活动开启关闭推送列表0-9]/g,"")){case"崩坏三":case"崩三":return 1;case"原神":return 2;case"崩坏学园二":case"崩坏二":case"崩二":return 3;case"未定事件簿":case"未定":return 4;case"星铁":return 6;case"绝区零":return 8}return 2}}export{a as mysNews};
