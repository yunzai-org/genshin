import{plugin as t}from"yunzai";import{renderImg as e,PayData as i}from"../model/payLogData.js";import{NoteUser as r}from"yunzai-mys";import a from"fs";import s from"path";import u from"yaml";class h extends t{dirPath=s.resolve("./data/payLog/");authKey="";constructor(){super({priority:299,rule:[{reg:"^#?(充值|消费)(记录|统计)$",fnc:"payLog"},{reg:"^#?更新(充值|消费)(记录|统计)$",fnc:"updatePayLog"},{reg:"(.*)(user-game-search|bill-record-user|customer-claim|player-log|user.mihoyo.com)(.*)",fnc:"getAuthKey"},{reg:"^#?(充值|消费)(记录|统计)帮助$",fnc:"payLogHelp"}]})}async payLog(t){if(!a.readdirSync(this.dirPath,"utf-8").includes(t.user_id+".yaml"))return await this.updatePayLog(),!0;const i=await this.isMain(t.user_id);let r=a.readFileSync(this.dirPath+`/${t.user_id}.yaml`,"utf-8");if(r=u.parse(r),!i){let t=Object.keys(r),i=await e(r[t[0]]);return this.reply(i),!0}if(r[i]){let t=await e(r[i]);return this.reply(t),!0}return this.reply("当前绑定的uid未获取数据，请私聊获取"),!1}async getAuthKey(){if(this.e.isGroup)return!1;if(!this.e.msg.includes("authkey"))return this.reply("链接无效,请重新发送"),!1;let t=this.e.msg.match(/&authkey=([^&\s\u4e00-\u9fa5]+)/);if(!t)return this.reply("链接无效,请重新发送"),!1;this.authKey=decodeURIComponent(t[1]),this.reply("正在获取消费数据,可能需要30s~~");let r=new i(this.authKey),a=await r.filtrateData();if(a?.errorMsg)return this.reply(a?.errorMsg),!0;let s=await e(a);return this.reply(s),await this.writeData(a),await redis.setEx(`Yz:genshin:mys:qq-uid:${this.e.user_id}`,2592e3,a.uid),await redis.setEx(`Yz:genshin:payLog:${a.uid}`,86400,this.authKey),!0}async updatePayLog(t){let r=await redis.get(`Yz:genshin:mys:qq-uid:${this.e.user_id}`);if(r){let t=await this.isMain(this.e.user_id);if(t&&(r=t),this.authKey=await redis.get(`Yz:genshin:payLog:${r}`)||await redis.get(`Yz:genshin:gachaLog:url:${r}`),this.authKey){this.reply("正在获取数据,可能需要30s");let t=await new i(this.authKey).filtrateData();if(t?.errorMsg)this.reply(t.errorMsg);else{let i=await e(t);this.reply(i),await this.writeData(t)}return!0}this.reply(["请私聊发送米游社链接，可以发送【#充值统计帮助】查看链接教程",segment.button([{text:"充值帮助",callback:"#充值统计帮助"}])])}else this.reply(["请私聊发送米游社链接，可以发送【#充值统计帮助】查看链接教程",segment.button([{text:"充值帮助",callback:"#充值统计帮助"}])]);return!0}payLogHelp(t){t.reply("安卓教程： https://b23.tv/K5qfLad\n苹果用户可【先】发送最新获取的抽卡记录链接，【再】发送【#充值记录】或【#更新充值统计】来获取（注：通过抽卡链接获取充值记录大概率已失效）")}async isMain(t,e="gs"){return(await r.create(t)).getCkUid(e)}async writeData(t){let e=this.dirPath+"/"+this.e.user_id+".yaml";if(a.readdirSync(this.dirPath).includes(`${this.e.user_id}.yaml`)){let i=a.readFileSync(e,"utf-8");i=u.parse(i),i[t.uid]=t,a.writeFileSync(e,u.stringify(i),"utf-8")}else{let i={};i[t.uid]=t,a.writeFileSync(e,u.stringify(i),"utf-8")}}}export{h as payLog};
