import{Plugin as e,sleep as i}from"yunzai";import t from"node:fs";import o from"lodash";import s from"node-fetch";import c from"yaml";import{GSCfg as a,MysInfo as r}from"yunzai-mys";class n extends e{constructor(){super({priority:700,rule:[{reg:/^#配置c(oo)?k(ie)?$|^#*配置公共查询c(oo)?k(ie)?$/i,fnc:"setPubCk",permission:"master"},{reg:"^#使用(全部|用户)ck$",fnc:"setUserCk",permission:"master"}]})}file="./plugins/genshin/config/mys.pubCk.yaml";async setPubCk(){this.setContext("pubCk"),await this.reply("请发送米游社cookie......\n配置后该ck将会加入公共查询池")}async pubCk(){let e=this.e.msg;if(!/(ltoken|ltoken_v2)/.test(this.e.msg)||!/(ltuid|ltmid_v2|account_mid_v2)/.test(this.e.msg))return this.e.reply("cookie错误，请发送正确的cookie"),!0;this.finish("pubCk");let i=e.replace(/#|"|"/g,""),t={};if(i.split(";").forEach((e=>{let i=o.trim(e),s=i.indexOf("=");t[i.slice(0,s)]=i.slice(s+1)})),this.ck="",o.forEach(t,((e,i)=>{["ltoken","ltuid","cookie_token","account_id","cookie_token_v2","account_mid_v2","ltmid_v2","ltoken_v2"].includes(i)&&(this.ck+=`${i}=${e};`)})),!await this.checkCk())return logger.mark(`配置公共cookie错误：${this.checkMsg||"cookie错误"}`),void await this.e.reply(`配置公共cookie错误：${this.checkMsg||"cookie错误"}`);if(this.ltuid=t.ltuid,t.cookie_token_v2&&(t.account_mid_v2||t.ltoken_v2)&&!/(\d{4,9})/g.test(this.ltuid)){let e=await this.getUserInfo();if(!e?.data?.user_info)return logger.mark(`配置公共cookie错误：${e.message||"cookie错误"}`),void await this.e.reply(`配置公共cookie错误：${e.message||"cookie错误"}`);{let i=e?.data?.user_info;this.ltuid=i.uid,this.ck=`${this.ck}ltuid=${this.ltuid};`}}let s=a.getConfig("mys","pubCk")||[];for(let e of s)if(e.includes(this.ltuid))return void await this.e.reply("配置公共cookie错误：该ck已配置");s.push(this.ck),this.save(s),a.change_myspubCk(),await this.e.reply(`配置公共ck成功：第${s.length}个`)}async checkCk(){let e=await s("https://api-takumi.mihoyo.com/binding/api/getUserGameRolesByCookie?game_biz=hk4e_cn",{method:"get",headers:{Cookie:this.ck}});return!!e.ok&&(e=await e.json(),0==e.retcode||(this.checkMsg=e.message,!1))}async getUserInfo(e="mys"){try{const i=this;let t={mys:"https://bbs-api.mihoyo.com/user/wapi/getUserFullInfo?gids=2",hoyolab:""},o=await s(t[e],{method:"get",headers:{Cookie:i.ck,Accept:"application/json, text/plain, */*",Connection:"keep-alive",Host:"bbs-api.mihoyo.com",Origin:"https://m.bbs.mihoyo.com",Referer:" https://m.bbs.mihoyo.com/"}});return o.ok?(o=await o.json(),o):o}catch(e){return null}}save(e){e=c.stringify(e),t.writeFileSync(this.file,e)}async setUserCk(){let e="./plugins/genshin/config/mys.set.yaml",o=t.readFileSync(e,"utf8");o=o.replace(/allowUseCookie: [0-1]/g,"allowUseCookie: 1"),t.writeFileSync(e,o,"utf8"),await i(500),await r.initCache(!0),await this.reply("开启成功，用户ck已加入公共查询ck池")}}export{n as setPubCk};
