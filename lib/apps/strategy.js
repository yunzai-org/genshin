import{plugin as t,downFile as e}from"yunzai";import{gsCfg as s}from"yunzai-mys";import i from"lodash";import a from"node:fs";import r from"node-fetch";s.cpCfg("mys","set");class n extends t{path="./temp/strategy";url="https://bbs-api.mihoyo.com/post/wapi/getPostFullInCollection?&gids=2&order_type=2&collection_id=";collection_id=[[],[2319292,2319293,2319295,2319296,2319299,2319294,2319298],[813033],[341284],[341523],[1582613],[22148],[1812949]];source=["西风驿站","原神观测枢","派蒙喵喵屋","OH是姜姜呀","曉K","坤易","婧枫赛赛"];oss="?x-oss-process=image//resize,s_1200/quality,q_90/auto-orient,0/interlace,1/format,jpg";constructor(){super({priority:50,rule:[{reg:"^#?(更新)?\\S+攻略([1-7])?$",fnc:"strategy"},{reg:"^#?攻略(说明|帮助)?$",fnc:"strategy_help"},{reg:"^#?设置默认攻略([1-7])?$",fnc:"strategy_setting"}]}),this.set=s.getConfig("mys","set")}set=null;async init(){a.existsSync(this.path)||a.mkdirSync(this.path);for(let t of[1,2,3,4,5,6,7]){let e=this.path+"/"+t;a.existsSync(e)||a.mkdirSync(e)}}async strategy(){let t=/^#?(更新)?(\S+)攻略([1-7])?$/.exec(this.e.msg),e=!!t[1],i=t[2],r=t[3]?t[3]:this.set.defaultSource,n=s.getRole(i);if(!n)return!1;if(["10000005","10000007","20000000"].includes(String(n.roleId))){let t=["风主","岩主","雷主","草主","水主"];if(!t.includes(n.alias)){let e="请选择：";for(let s of t)e+=`${s}攻略${r}、`;return e=e.substring(0,e.lastIndexOf("、")),void await this.e.reply(e)}n.name=n.alias}this.sfPath=`${this.path}/${r}/${n.name}.jpg`;let l=[];for(const t of[1,2,3,4,5,6,7])l.push({text:String(t),callback:`#${n.name}攻略${t}`});l=segment.button(l),!a.existsSync(this.sfPath)||e?await this.getImg(n.name,r)&&await this.e.reply([segment.image(`file://${this.sfPath}`),l]):await this.e.reply([segment.image(`file://${this.sfPath}`),l])}async strategy_help(){await this.e.reply("攻略帮助:\n#心海攻略[1234567]\n#更新早柚攻略[1234567]\n#设置默认攻略[1234567]\n示例: 心海攻略4\n\n攻略来源:\n1——西风驿站\n2——原神观测枢\n3——派蒙喵喵屋\n4——OH是姜姜呀\n5——曉K\n6——坤易\n7——婧枫赛赛(角色配队一图流)")}async strategy_setting(){let t=/^#?设置默认攻略([1-7])?$/.exec(this.e.msg),e="./plugins/genshin/config/mys.set.yaml",s=a.readFileSync(e,"utf8"),i=Number(t[1]);isNaN(i)?await this.e.reply("默认攻略设置方式为: \n#设置默认攻略[1234567] \n 请增加数字1-7其中一个"):(s=s.replace(/defaultSource: [1-7]/g,"defaultSource: "+i),a.writeFileSync(e,s,"utf8"),await this.e.reply("默认攻略已设置为: "+t[1]))}async getImg(t,s){let a=[];this.collection_id[s].forEach((t=>a.push(this.getData(this.url+t))));try{a=await Promise.all(a)}catch(t){return this.e.reply("暂无攻略数据，请稍后再试"),logger.error(`米游社接口报错：${t}}`),!1}let r,n=i.flatten(i.map(a,(t=>t.data.posts)));for(let e of n)if(4==s){if(e.post.structured_content.includes(t+"】")){let s=e.post.structured_content.replace(/\\\/\{\}/g,""),i=new RegExp(t+'】.*?image\\\\?":\\\\?"(.*?)\\\\?"').exec(s)[1];for(let t of e.image_list)if(t.image_id==i){r=t.url;break}break}}else if(e.post.subject.includes(t)){let t=0;e.image_list.forEach(((s,i)=>{Number(s.size)>=Number(e.image_list[t].size)&&(t=i)})),r=e.image_list[t].url;break}return r?(logger.mark(`${this.e.logFnc} 下载${t}攻略图`),!!await e(r+this.oss,this.sfPath)&&(logger.mark(`${this.e.logFnc} 下载${t}攻略成功`),!0)):(this.e.reply([`暂无${t}攻略（${this.source[s-1]}）\n请尝试其他的攻略来源查询\n#攻略帮助，查看说明`,segment.button([{text:"攻略帮助",callback:"#攻略帮助"}])]),!1)}async getData(t){let e=await r(t,{method:"get"});if(!e.ok)return!1;return await e.json()}}export{n as strategy};
