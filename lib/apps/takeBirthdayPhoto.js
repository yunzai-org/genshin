import{plugin as t}from"yunzai";import{MysInfo as e}from"yunzai-mys";import i from"node-fetch";class a extends t{constructor(){super({priority:5e3,rule:[{reg:"^#?(留影(叙佳期)?|((领)?((角色)?生日)(卡)?))$",fnc:"birthdaystar"}]}),this.button=segment.button([{text:"留影叙佳期",input:"#留影叙佳期"}])}button=null;async birthdaystar(t){let i=await e.getUid(this.e);if(!i)return!1;let a=await e.checkUidBing(i,this.e);if(!a)return t.reply(["请先绑定ck再使用本功能哦~",segment.button([{text:"Cookie帮助",callback:"#Cookie帮助"}])],!0),!0;this.region=await this.getServer(i),this.game_biz=this.region.includes("cn")?"hk4e_cn":"hk4e_global";const r=await this.getEHK4EToken(a.ck,i);if(!r)return t.reply(["获取e-hk4e_token失败，请刷新ck后再试~",this.button],!0),!0;const o=await this.getBirthdayStar(i,r,a.ck);if(!o)return t.reply(["获取生日角色失败，请稍后再试~",this.button],!0),!0;if(0===o.length)return t.reply(["今天没有生日角色哦~",this.button],!0),!0;try{for(const e of o){await t.reply(`正在获取${e.name}的图片，请稍等~`,!0),await t.reply(segment.image(e.take_picture));const o=await this.getBirthdayStarImg(i,r,a.ck,e.role_id);if("success"!=o)return await t.reply([o,this.button]),!0;await t.reply(`获取${e.name}的图片成功~`,!0)}}catch(e){await t.reply(["获取角色留影叙佳期图片失败，可能是ck失效...",this.button],!0),logger.error(e)}return!0}async getEHK4EToken(t,e){const a=this.region.includes("cn")?"https://api-takumi.mihoyo.com/common/badge/v1/login/account":"https://api-os-takumi.mihoyo.com/common/badge/v1/login/account",r={Cookie:t,"Content-Type":"application/json;charset=UTF-8",Referer:"https://webstatic.mihoyo.com/",Origin:"https://webstatic.mihoyo.com"},o=JSON.stringify({uid:Number(e),game_biz:this.game_biz,lang:"zh-cn",region:this.region});let n=await i(a,{method:"POST",body:o,headers:r});const s=n.headers.get("set-cookie").match(/e_hk4e_token=(.*?);/)[1];return n=await n.json(),0==n.retcode&&s}async getServer(t){switch(String(t).slice(0,-8)){case"1":case"2":return"cn_gf01";case"5":return"cn_qd01";case"6":return"os_usa";case"7":return"os_euro";case"8":case"18":return"os_asia";case"9":return"os_cht"}return"cn_gf01"}async getBirthdayStar(t,e,a){const r={Cookie:`e_hk4e_token=${e};${a}`},o=`https://hk4e-api.mihoyo.com/event/birthdaystar/account/index?lang=zh-cn&badge_uid=${t}&badge_region=${this.region}&game_biz=${this.game_biz}&activity_id=20220301153521`;let n=await i(o,{headers:r});return n=await n.json(),n.data.role}async getBirthdayStarImg(t,e,a,r){const o={Cookie:`e_hk4e_token=${e};${a}`},n=`https://hk4e-api.mihoyo.com/event/birthdaystar/account/post_my_draw?lang=zh-cn&badge_uid=${t}&badge_region=${this.region}&game_biz=${this.game_biz}&activity_id=20220301153521`,s=JSON.stringify({role_id:Number(r)});let c=await i(n,{method:"POST",body:s,headers:o});return c=await c.json(),0!=c.retcode?c.message:"success"}}export{a as takeBirthdayPhoto};
