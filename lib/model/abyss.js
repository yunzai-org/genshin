import e from"moment";import t from"lodash";import a from"./base.js";import{MysInfo as s}from"yunzai-mys";import{Character as r}from"../miao.js";class i extends a{constructor(e){super(e),this.model="abyss"}async getAbyss(){let e=1;(this.e.msg.includes("上期")||this.e.msg.includes("往期"))&&(e=2);let t={index:"",spiralAbyss:{schedule_type:e}};this.e.apiSync=!0;let a=await s.get(this.e,t,"");if(!a||0!==a[0].retcode||0!==a[1].retcode)return!1;let r=a[1].data;return r?.total_battle_times<=0?(await this.e.reply(`uid${this.e.uid}，暂无挑战数据。`),!1):!r.damage_rank||r.damage_rank.length<=0?(await this.e.reply(`uid${this.e.uid}，数据还没更新，请稍后再试`),!1):{name:this.e.sender.card,quality:80,...this.screenData,...this.abyssData(r)}}abyssData(a){let s=e.unix(a.start_time),i=Number(s.month())+1;s.date()>=15?i+="月下":i+="月上";let l=0,o=[];for(let e of a.floors)e.index<9||(l+=e.star,o.push(e.star));l=l+"（"+o.join("-")+"）";let n=["damage","take_damage","defeat","normal_skill","energy_skill"],m=[];for(let e of n){(t.isEmpty(a[`${e}_rank`])||a[`${e}_rank`].length<=0)&&(a[`${e}_rank`]=[{value:0,avatar_id:10000007}]);let s=r.get(a[`${e}_rank`][0].avatar_id);m[e]={num:a[`${e}_rank`][0].value,name:s.abbr,icon:s.side},m[e].num>1e3&&(m[e].num=(m[e].num/1e4).toFixed(1),m[e].num+=" w")}for(let e in a.reveal_rank){let t=r.get(a.reveal_rank[e].avatar_id);a.reveal_rank[e].name=t.abbr,a.reveal_rank[e].icon=t.face}return{saveId:this.e.uid,uid:this.e.uid,time:i,max_floor:a.max_floor,total_star:l,list:a.reveal_rank,total_battle_times:a.total_battle_times,...m}}async getAbyssFloor(){this.model="abyssFloor";let e=1;(this.e.msg.includes("上期")||this.e.msg.includes("往期"))&&(e=2);let a={index:"",spiralAbyss:{schedule_type:e}};this.e.sync=!0;let r=await s.get(this.e,a);if(!r||0!==r[0].retcode||0!==r[1].retcode)return!1;let i=r[0].data,l=r[1].data,o=this.e.uid,n=this.getFloor();if(!n)return await this.e.reply("深渊层数错误"),!1;if(t.isEmpty(l.floors))return await this.e.reply(`uid:${o}，暂无第${n}层数据`),!1;let m=t.keyBy(l.floors,"index");return t.isEmpty(m[n])?(await this.e.reply(`uid:${o}，暂无第${n}层数据`),!1):{saveId:o,uid:o,floorIndex:n,...this.screenData,...this.abyssFloorData(m[n],i)}}getFloor(){let e=this.e.msg.match(/^#*[上期]*(深渊|深境|深境螺旋)[上期]*[第]*(9|10|11|12|九|十|十一|十二)层[ |0-9]*$/);if(!e)return!1;switch(e=e[2],e){case"9":case"九":e=9;break;case"10":case"十":e=10;break;case"11":case"十一":e=11;break;case"12":case"十二":e=12;break;default:e=""}return e}abyssFloorData(a,s){let i=t.keyBy(s.avatars,"id"),l=[];for(let t of a.levels)if(t.battles&&!(t.battles.length<2)){t.time=e.unix(t.battles[0].timestamp).format("YYYY-MM-DD HH:mm:ss");for(let e in t.battles)for(let a in t.battles[e].avatars){let s=r.get(t.battles[e].avatars[a].id);t.battles[e].avatars[a].name=s.abbr,t.battles[e].avatars[a].icon=s.face,t.battles[e].avatars[a].life=i[t.battles[e].avatars[a].id].actived_constellation_num}l.push(t)}return{floor:a,list:l}}}export{i as default};
