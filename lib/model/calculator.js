import e from"./base.js";import{MysInfo as t,MysApi as i,gsCfg as r}from"yunzai-mys";import a from"lodash";class l extends e{constructor(e){super(e),this.model="calculator",this.checkMsg="设置角色、武器、技能等级有误\n指令："+(e.isSr?"*克拉拉养成\n示例：*克拉拉养成75 80 6 9 9 9\n参数为角色、武器、普攻、战技、终结技、天赋":"#刻晴养成\n示例：#刻晴养成81 90 9 9 9\n参数为角色、武器、技能等级")}async get(e){this.role=e;let r=await t.getUid(this.e);if(!r)return!1;let a=await t.checkUidBing(r,this.e);if(!a)return await this.e.reply(t.tips),!1;this.mysApi=new i(r,a.ck,{log:!0});let l=await t.get(this.e,"getFp");this.headers={"x-rpc-device_fp":l?.data?.device_fp};let s=await t.get(this.e,this.e.isSr?"avatarInfo":"character",{headers:this.headers});if(!s||0!==s.retcode)return!1;s=s.data,await this.getSet(),this.dataCharacter=s[this.e.isSr?"avatar_list":"avatars"].find((t=>t.id==e.roleId));let h=await this.getBody();if(!h)return!1;let d=await this.computes(h);return!!d&&{saveId:r,uid:r,dataCharacter:this.dataCharacter,setSkill:this.setSkill,skillList:this.skillList,computes:d,...this.screenData}}async getSet(){let e=this.e.isSr?"80,80,6,10,10,10".split(","):"90,90,10,10,10".split(","),t=this.e.msg.replace(/#|＃|星铁|养成|计算/g,"").trim();t=t.replace(/，| /g,","),t=t.replace(this.role.alias,"");let i=[],r=this.e.isSr?6:5;if(t){i=t.split(","),i=a.compact(i);for(let t=0;t<r;t++)i[t]||(i[t]=e[t])}else i=e;if(i.length!=r){let e=this.checkMsg.replace(/刻晴|克拉拉/g,this.role.alias);return await this.e.reply(e),!1}let l=this.e.isSr?[80,80,6,10,10,10]:[90,90,10,10,10];for(const e in l)l[e]<Number(i[e])&&(i[e]=l[e]);this.setSkill=i}async getBody(){let e,i=[];if(this.dataCharacter){let e=this.e.isSr?{avatar_id:this.role.roleId,tab_from:"TabOwned"}:{avatar_id:this.role.roleId},r=await t.get(this.e,"detail",{headers:this.headers,...e});if(!r||0!==r.retcode)return!1;i=r.data.skill_list||r.data.skills}else{if(this.e.isSr){let e=await t.get(this.e,"detail",{headers:this.headers,avatar_id:this.role.roleId,tab_from:"TabAll"});if(!e||0!==e.retcode)return!1;this.avatar=e.data.avatar,i=e.data.skills}else i=await this.getSkillId(this.role.roleId);if(!i)return this.e.reply("暂无角色数据,请稍后再试\n星铁角色养成请使用*开头"),!1;let e=r.getdefSet("role","other").four;this.dataCharacter={level:1,name:this.role.name,icon:this.e.isSr?this.avatar.icon_url:`${this.screenData.pluResPath}img/role/${this.role.name}.png`,rarity:this.e.isSr?this.avatar.rarity:e.includes(Number(this.role.roleId))?4:5}}if(this.e.isSr){e={game:"hkrpg",avatar:{item_id:Number(this.role.roleId),cur_level:Number(this.dataCharacter.level),target_level:Number(this.setSkill[0])},skill_list:[]};let t=this.setSkill.slice(2);i.forEach(((i,r)=>{e.skill_list.push({item_id:i.point_id,cur_level:i.cur_level,target_level:Number(t[r])||i.target_level})}))}else i=i.filter((e=>1!=e.max_level)),e={avatar_id:Number(this.role.roleId),avatar_level_current:Number(this.dataCharacter.level),avatar_level_target:Number(this.setSkill[0]),skill_list:[{id:Number(i[0].group_id),level_current:Number(i[0].level_current),level_target:Number(this.setSkill[2])},{id:Number(i[1].group_id),level_current:Number(i[1].level_current),level_target:Number(this.setSkill[3])},{id:Number(i[2].group_id),level_current:Number(i[2].level_current),level_target:Number(this.setSkill[4])}]};return this.mysApi.getServer().startsWith("os")&&(e.lang="zh-cn"),this.e.isSr?this.dataCharacter.equip&&(e.equipment={item_id:Number(this.dataCharacter.equip.id),cur_level:Number(this.dataCharacter.equip.level),target_level:Number(this.setSkill[1])}):this.dataCharacter.weapon&&(Number(this.dataCharacter.weapon.rarity)<3&&(this.setSkill[1]=70),e.weapon={id:Number(this.dataCharacter.weapon.id),level_current:Number(this.dataCharacter.weapon.level),level_target:Number(this.setSkill[1])}),i=i.filter((e=>1!=e.max_level)),this.skillList=i,this.e.isSr?e:{items:[e]}}async getSkillId(e){let i=await t.get(this.e,"avatarSkill",{headers:this.headers,avatar_id:e});return!(!i||0!==i.retcode)&&(i=i.data,i.list.forEach((e=>{e.level_current=1})),i.list)}async computes(e){let i=await t.get(this.e,"compute",{body:e,headers:this.headers});if(!i||0!==i.retcode)return!1;i=this.e.isSr?i.data:i.data.overall_material_consume;let r={},a=e=>e>1e4?(e/1e4).toFixed(1)+" w":e;this.e.isSr&&delete i.coin_id;for(let e in i)if(r[e]=[],this.e.isSr)for(let t in i[e])i[e][t].num=a(i[e][t].num),i[e][t].item_name.includes("「")&&(i[e][t].isTalent=!0),r[e].push(i[e][t]);else i[e].forEach((({consume:t})=>{t.forEach((t=>{r[e].push(t),t.num=a(t.num),t.name.includes("「")&&(t.isTalent=!0)}))}));return r}}export{l as default};
