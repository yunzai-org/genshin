import e from"./base.js";import{downFile as t,ConfigController as i}from"yunzai";import s from"node:fs";import a from"moment";import r from"./gachaLog.js";import n from"lodash";class h extends e{constructor(e){super(e),this.model="gachaLog",this.urlKey=`${this.prefix}url:`,this.uidKey=`Yz:genshin:mys:qq-uid:${this.userId}`,this.path=this.e.isSr?`./data/srJson/${this.e.user_id}/`:`./data/gachaJson/${this.e.user_id}/`,this.game=this.e.game,this.pool=(e="gs")=>({gs:[{type:301,typeName:"角色活动"},{type:302,typeName:"武器活动"},{type:200,typeName:"常驻"}],sr:[{type:11,typeName:"角色活动"},{type:12,typeName:"武器活动"},{type:2,typeName:"新手活动"},{type:1,typeName:"常驻"}]}[e]),this.typeName=(e="gs")=>({gs:{301:"角色",302:"武器",200:"常驻"},sr:{11:"角色",12:"武器",2:"新手",1:"常驻"}}[e])}async exportJson(){if(this.e.isSr||await t("https://api.uigf.org/dict/genshin/chs.json","./temp/uigf/genshin.json"),await this.getUid(),!this.uid)return!1;let e=this.getAllList().list,r=i.package.name;r="miao-yunzai"==r?"Miao-Yunzai":"yunzai"==r?"Yunzai-Bot":"trss-yunzai"==r?"TRSS-Yunzai":_.capitalize(r);let n={info:{uid:this.uid,lang:e[0].lang,export_time:a().format("YYYY-MM-DD HH:mm:ss"),export_timestamp:a().format("X"),export_app:r,export_app_version:i.package.version},list:e};this.e.isSr?(n.info.srgf_version="v1.0",n.info.region_time_zone=a(e[0].time).utcOffset()/60):n.info.uigf_version="v2.3";let h=`${this.path}${this.uid}/${this.uid}.json`;s.writeFileSync(h,JSON.stringify(n,"","\t")),logger.mark(`${this.e.logFnc} 导出成功${this.uid}.json`),this.e.reply(`导出成功：${this.uid}.json，共${e.length}条 \n请接收文件`),this.e.group?.sendFile?await this.e.group.sendFile(h):this.e.friend?.sendFile?await this.e.friend.sendFile(h):this.e.reply("导出失败：暂不支持发送文件"),s.unlink(h,(()=>{}))}async getUid(){let e=new r(this.e),t=await e.getUid();return!!t&&(this.uid=t,this.uid)}getAllList(){let e="./temp/uigf/genshin.json";try{e=JSON.parse(s.readFileSync(e,"utf8"))}catch(t){e=!1}let t={list:[]},i={};for(let r of this.pool(this.game)){let n=`${this.path}${this.uid}/${r.type}.json`;s.existsSync(n)?(n=JSON.parse(s.readFileSync(n,"utf8")),n=n.reverse()):n=[],t[r.type]=n;for(let s of n){!s.item_id&&e&&(s.item_id=String(e[s.name])),this.e.isSr||(301==s.gacha_type||400==s.gacha_type?s.uigf_gacha_type="301":s.uigf_gacha_type=s.gacha_type);let r=s.id;if(r?13==r.length&&(s.id=`${r}000000`):(r=a(s.time).format("x")+"000000",s.id=r),i[r]){let e=`${r}00000${i[r].length}`;i[r].push(e),s.id=e}else i[r]=[r];t.list.push(s)}}return t.list=n.orderBy(t.list,["id","asc"]),t}loadJson(e){return s.existsSync(e)?JSON.parse(s.readFileSync(e,"utf8")):[]}async logJson(){let e=/([1-9]|18)[0-9]{8}/g.exec(this.e.file.name)[0],i=`${this.path}${this.e.file.name}`,a=await this.e.friend.getFileUrl(this.e.file.fid);if(!await t(a,i))return this.e.reply("下载json文件错误"),!1;let h={};try{h=JSON.parse(s.readFileSync(i,"utf8"))}catch(e){return this.e.reply(`${this.e.file.name},json格式错误`),!1}if(n.isEmpty(h)||!h.list)return this.e.reply("json文件内容错误：非统一祈愿记录标准"),!1;h.info.srgf_version&&(this.e.isSr=!0,this.game="sr");let o=this.dealJson(h.list);if(!o)return!1;let l=[];for(let t in o){let i=this.typeName(this.game);if(!i[t])continue;let s=new r(this.e);s.uid=e,s.type=t,s.writeJson(o[t]),l.push(`${i[t]}记录：${o[t].length}条`)}s.unlink(i,(()=>{})),await this.e.reply(`${this.e.file.name}，${this.e.isSr?"星铁":"原神"}记录导入成功\n${l.join("\n")}`)}dealJson(e){let t={},i=["gacha_type","item_type","name","time"];for(let t of i)if(!e[0][t])return this.e.reply(`json文件内容错误：缺少必要字段${t}`),!1;a(e[0].time).format("x")<a(e[e.length-1].time).format("x")&&(e=e.reverse());for(let i of e)"sr"===this.game&&(i.uigf_gacha_type=i.gacha_type),t[i.uigf_gacha_type]||(t[i.uigf_gacha_type]=[]),t[i.uigf_gacha_type].push(i);return t}}export{h as default};
