import e from"./base.js";import{gsCfg as t}from"yunzai-mys";import s from"lodash";import i from"moment";import{Character as r,Weapon as h}from"../miao.js";class n extends e{constructor(e){super(e),this.model="gacha",this.pool={},this.def=t.getdefSet("gacha","gacha"),this.set=t.getGachaSet(this.e.group_id),this.ele=t.element,this.type="role",this.res=[],this.fiveHave=[],this.fourHave=[]}static async init(e){let t=new n(e);return t.getTpye(),await t.userData(),await t.getPool(),t}static getImg(e,t="role"){if("role"===t||"角色"===t){let t=r.get(e);return t?.imgs?.gacha||""}if("weapon"===t||"武器"===t){let t=h.get(e);return t?.imgs?.gacha||""}}async run(){let e=this.lottery();return{name:this.e.sender.card,quality:80,...this.screenData,...this.lotteryInfo(),list:e}}get key(){return this.e.isGroup?`${this.prefix}${this.e.group_id}:${this.userId}`:`${this.prefix}private:${this.userId}`}getTpye(){this.e.msg.includes("2")&&(this.role2=!0),this.e.msg.includes("武器")&&(this.type="weapon"),this.e.msg.includes("常驻")&&(this.type="permanent")}async getPool(){let e=t.getdefSet("gacha","pool");e=[...e].reverse();let i=e.find((e=>(new Date).getTime()<=new Date(e.endTime).getTime()))||e.pop();if(this.NowPool=i,"weapon"==this.type){let e=s.difference(this.def.weapon4,i.weapon4),t=s.difference(this.def.weapon5,i.weapon5);this.pool={up4:i.weapon4,role4:this.def.role4,weapon4:e,up5:i.weapon5,five:t}}if("role"==this.type){let e=s.difference(this.def.role4,i.up4),t=s.difference(this.def.role5,i.up5),r=i.up5;this.role2&&(r=i.up5_2),this.pool={up4:i.up4,role4:e,weapon4:this.def.weapon4,up5:r,five:t}}"permanent"==this.type&&(this.pool={up4:[],role4:this.def.role4,weapon4:this.def.weapon4,up5:[],five:this.def.role5,fiveW:this.def.weapon5}),this.pool.weapon3=this.def.weapon3}async userData(){if(this.user)return this.user;let e=await redis.get(this.key);if(e)e=JSON.parse(e),this.getNow()>e.today.expire&&(e.today={star:[],expire:this.getEnd().end4,num:0,weaponNum:0}),this.getNow()>e.week.expire&&(e.week={num:0,expire:this.getWeekEnd()});else{let t={num4:0,isUp4:0,num5:0,isUp5:0};e={permanent:t,role:t,weapon:{...t,lifeNum:0,type:1},today:{star:[],expire:this.getEnd().end4,num:0,weaponNum:0},week:{num:0,expire:this.getWeekEnd()}}}return this.user=e,e}lottery(e=!0){for(let e=1;e<=10;e++)this.index=e,"weapon"==this.type?this.user.today.weaponNum++:this.user.today.num++,this.lottery5()||this.lottery4()||this.lottery3();return e&&this.saveUser(),this.res=s.orderBy(this.res,["star","type","have","index"],["desc","asc","asc","asc"]),this.res}lottery5(){let e=!1,t=!1,i=this.probability(),r=this.type;if(s.random(1,1e4)>i)return this.user[this.type].num5++,!1;let h=this.user[this.type].num5+1;this.user[this.type].num5=0,this.user[this.type].num4++;let p=this.def.wai;1==this.user[this.type].isUp5&&(p=101),"permanent"==this.type&&(p=0);let a="";"weapon"==this.type&&this.user[this.type].lifeNum>=2?(a=this.getBingWeapon(),this.user[this.type].lifeNum=0,t=!0):s.random(1,100)<=p?(1==this.user[this.type].isUp5&&(e=!0),this.user[this.type].isUp5=0,a=s.sample(this.pool.up5),a==this.getBingWeapon()&&(this.user[this.type].lifeNum=0)):"permanent"==this.type?s.random(1,100)<=50?(a=s.sample(this.pool.five),r="role"):(a=s.sample(this.pool.fiveW),r="weapon"):(this.user[this.type].isUp5=1,a=s.sample(this.pool.five)),a!=this.getBingWeapon()&&this.user[this.type].lifeNum++,this.user.today.star.push({name:a,num:h}),this.user.week.num++;let o=!1;return this.fiveHave.includes(a)?o=!0:this.fiveHave.push(a),this.res.push({name:a,star:5,type:r,num:h,element:this.ele[a]||"",index:this.index,isBigUP:e,isBing:t,have:o,imgFile:n.getImg(a,r),rand:s.random(1,7)}),!0}lottery4(){let e=this.def.chance4;if(this.user[this.type].num4>=9?e+=1e4:this.user[this.type].num4>=5&&(e+=500*Math.pow(this.user[this.type].num4-4,2)),s.random(1,1e4)>e)return this.user[this.type].num4++,!1;this.user[this.type].num4=0;let t=50;"weapon"==this.type&&(t=75),1==this.user[this.type].isUp4&&(this.user[this.type].isUp4=0,t=100),"permanent"==this.type&&(t=0);let i="role",r="";s.random(1,100)<=t?(r=s.sample(this.pool.up4),i=this.type):(this.user[this.type].isUp4=1,s.random(1,100)<=50?(r=s.sample(this.pool.role4),i="role"):(r=s.sample(this.pool.weapon4),i="weapon"));let h=!1;return this.fourHave.includes(r)?h=!0:this.fourHave.push(r),this.res.push({name:r,star:4,type:i,element:this.ele[r]||"",index:this.index,imgFile:n.getImg(r,i),have:h}),!0}lottery3(){let e=s.sample(this.pool.weapon3);return this.res.push({name:e,star:3,type:"weapon",element:this.ele[e]||"",index:this.index,imgFile:n.getImg(e,"weapon")}),!0}probability(){let e=this.def.chance5;return"role"!=this.type&&"permanent"!=this.type||(1==this.user.week.num&&(e*=2),this.user[this.type].num5>=90?e=1e4:this.user[this.type].num5>=74?e=590+530*(this.user[this.type].num5-74):this.user[this.type].num5>=60&&(e=this.def.chance5+40*(this.user[this.type].num5-50))),"weapon"==this.type&&(e=this.def.chanceW5,1==this.user.week.num&&(e*=3),this.user[this.type].num5>=80?e=1e4:this.user[this.type].num5>=62?e+=700*(this.user[this.type].num5-61):this.user[this.type].num5>=45?e+=60*(this.user[this.type].num5-45):this.user[this.type].num5>=10&&this.user[this.type].num5<=20&&(e+=30*(this.user[this.type].num5-10))),e}getBingWeapon(e=!1){if("weapon"!=this.type)return!1;let s=this.pool.up5[this.user[this.type].type-1];return e&&(s=t.shortName(s,!0)),s}lotteryInfo(){let e=`累计「${this.user[this.type].num5}抽」`,s=0,i=0;this.res.forEach(((t,n)=>{if(5==t.star){if(s++,"role"==t.type){let s=r.get(t.name);e=s?.abbr||""}else{let s=h.get(t.name);e=s.abbr||""}e+=`「${t.num}抽」`,t.isBigUP&&(e+="大保底"),t.isBing&&(e+="定轨")}4==t.star&&i++}));let n=`角色池：${t.shortName(this.pool.up5[0])}`;"permanent"==this.type&&(n="常驻池");let p={info:e,nowFive:s,nowFour:i,poolName:n,isWeapon:"weapon"==this.type,bingWeapon:this.getBingWeapon(!0),lifeNum:this.user[this.type]?.lifeNum||0};return logger.debug(`[${n}] [五星数：${s}] [${e}] [定轨：${p.lifeNum}]`),p}async saveUser(){this.user.today.expire=this.getEnd().end4,await redis.setEx(this.key,1209600,JSON.stringify(this.user))}getNow(){return i().format("X")}getEnd(){let e=i().endOf("day").format("X"),t=14400;return i().format("k")<4?t+=Number(i().startOf("day").format("X")):t+=Number(e),{end:e,end4:t}}getWeekEnd(){return Number(i().day(7).endOf("day").format("X"))}}export{n as default};
