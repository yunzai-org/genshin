import e from"./base.js";import t from"node-fetch";import i from"lodash";import a from"node:fs";import{sleep as s,downFile as n}from"yunzai";import{gsCfg as r}from"yunzai-mys";import{Character as l,Weapon as u}from"../miao.js";class o extends e{constructor(e){super(e),this.model="gachaLog",!e.isSr&&e.msg&&(e.isSr=/\/(common|hkrpg)\//.test(e.msg)),this.urlKey=`${this.prefix}url:`,this.uidKey=this.e.isSr?`Yz:srJson:mys:qq-uid:${this.userId}`:`Yz:genshin:mys:qq-uid:${this.userId}`,this.path=this.e.isSr?`./data/srJson/${this.e.user_id}/`:`./data/gachaJson/${this.e.user_id}/`;this.pool=e.isSr?[{type:11,typeName:"角色"},{type:12,typeName:"光锥"},{type:1,typeName:"常驻"},{type:2,typeName:"新手"}]:[{type:301,typeName:"角色"},{type:302,typeName:"武器"},{type:500,typeName:"集录"},{type:200,typeName:"常驻"}]}static getIcon(e,t="role",i=""){if("role"===t||"角色"===t){let t=l.get(e,i);return t||console.log("not-found-char",e,i),t?.imgs?.face||""}if("weapon"===t||"武器"===t||"光锥"===t){let t=u.get(e,i);return t||console.log("not-found-weapon",`[${e}]`,i),t?.imgs?.icon||""}}async logUrl(){let e=this.e.msg,t=this.dealUrl(e);if(!t)return;if(!await this.checkUrl(t))return;this.e.reply("链接发送成功，数据获取中……");let i=[],a="";for(let e in this.pool){this.type=this.pool[e].type,this.typeName=this.pool[e].typeName;let t=await this.updateLog();t&&(a+=`[${this.typeName}]记录获取成功，更新${t.num}条\n`),e<=1&&await s(500)}i.push(a),i.push(`\n抽卡记录更新完成，您还可回复\n【${this?.e?.isSr?"*":"#"}全部记录】统计全部抽卡数据\n【${this?.e?.isSr?"*光锥":"#武器"}记录】统计${this?.e?.isSr?"星铁光锥":"武器"}池数据\n【${this?.e?.isSr?"*":"#"}角色统计】按卡池统计数据\n【${this?.e?.isSr?"*":"#"}导出记录】导出记录数据`),await this.e.reply(i),this.isLogUrl=!0,this.all=[];let n=await this.getLogData();return this.e.msg=`[uid:${this.uid}]`,n}dealUrl(e){(e=e.replace(/〈=/g,"&")).includes("getGachaLog?")&&(e=e.split("getGachaLog?")[1]),e.includes("index.html?")&&(e=e.split("index.html?")[1]);let t=new URLSearchParams(e).entries(),i={};for(let e of t)i[e[0]]=e[1];return i.authkey?(i.authkey=i.authkey.replace(/#\/|#\/log/g,""),i):(this.e.reply("链接复制错误"),!1)}async downFile(){this.creatFile();let e=`${this.path}output_log.txt`,t=await this.e.friend.getFileUrl(this.e.file.fid);if(!await n(t,e))return this.e.reply("下载日志文件错误"),!1;let i=a.readFileSync(e,"utf-8").match(/auth_appid=webview_gacha(.*)hk4e_cn/);return a.unlink(e,(()=>{})),!(!i||!i[0])&&i[0]}async checkUrl(e){if(!e.region){let t=await this.logApi({size:6,authkey:e.authkey,region:this.e.isSr?"prod_gf_cn":"cn_gf01"});if(t?.data?.region||(t=await this.logApi({size:6,authkey:e.authkey,region:this.e.isSr?"prod_official_usa":"os_usa"})),!t?.data?.region)return await this.e.reply("链接复制错误或已失效"),!1;e.region=t?.data?.region}let t=await this.logApi({size:6,authkey:e.authkey,region:e.region});return-109==t.retcode?(await this.e.reply("2.3版本后，反馈的链接已无法查询！请用安卓方式获取链接"),!1):-101==t.retcode?(await this.e.reply("该链接已失效，请重新进入游戏，重新复制链接"),!1):400==t.retcode?(await this.e.reply("获取数据错误"),!1):-100==t.retcode?1e3==this.e.msg.length?(await this.e.reply("输入法限制，链接复制不完整，请更换输入法复制完整链接"),!1):(await this.e.reply("链接不完整，请长按全选复制全部内容（可能输入法复制限制），或者复制的不是历史记录页面链接"),!1):0!=t.retcode?(await this.e.reply("链接复制错误"),!1):t?.data?.list&&t.data.list.length>0?(this.uid=t.data.list[0].uid,await redis.setEx(this.uidKey,2592e3,String(this.uid)),await redis.setEx(`${this.urlKey}${this.uid}`,86400,e.authkey),!0):(await this.e.reply("暂无数据，请等待记录后再查询"),!1)}async logApi(e){let i="https://public-operation-hk4e.mihoyo.com/gacha_info/api/getGachaLog?";["cn_gf01","cn_qd01"].includes(e.region)||(i="https://hk4e-api-os.hoyoverse.com/gacha_info/api/getGachaLog?");let a=new URLSearchParams({authkey_ver:1,lang:"zh-cn",gacha_type:301,page:1,size:20,end_id:0,...e}).toString();this.e.isSr&&(i="https://api-takumi.mihoyo.com/common/gacha_record/api/getGachaLog?",["prod_gf_cn","prod_qd_cn"].includes(e.region)||(i="https://api-os-takumi.mihoyo.com/common/gacha_record/api/getGachaLog?"),a=new URLSearchParams({authkey_ver:1,lang:"zh-cn",gacha_type:11,page:1,size:20,game_biz:"hkrpg_cn",end_id:0,...e}).toString());let s=await t(i+a).catch((e=>{logger.error(`[获取抽卡记录失败] ${e}`)}));return s&&s.ok?await s.json():{retcode:400}}async updateLog(){let e=await redis.get(`${this.urlKey}${this.uid}`);if(!e)return!1;let t=await this.logApi({gacha_type:this.type,authkey:e,region:this.getServer()});if(0!==t.retcode||!t?.data?.list||t.data.list.length<=0)return logger.debug(`${this.e.logFnc} ${t.message||"error"}`),!1;logger.mark(`${this.e.logFnc}[UID:${this.uid}] 开始获取：${this.typeName}记录...`);let a=[],s=this.readJson();i.isEmpty(s.list)&&301===this.type&&await this.e.reply(`开始获取${this.typeName}记录，首次获取数据较多，请耐心等待...`);let n=await this.getAllLog(s.ids,e);if(n.hasErr)return this.e.reply(`获取${this.typeName}记录失败`),!1;let r=n.list.length;return r>0&&(a=n.list.concat(s.list),this.writeJson(a),this.all=a),{num:r}}async getAllLog(e,t,i=1,a=0){let n=await this.logApi({gacha_type:this.type,page:i,end_id:a,authkey:t,region:this.getServer()});if(await s(1e3),0!=n.retcode)return{hasErr:!0,list:[]};if(!n?.data?.list||n.data.list.length<=0)return logger.mark(`${this.e.logFnc}[UID:${this.uid}] 获取${this.typeName}记录完成，共${Number(i)-1}页`),{hasErr:!1,list:[]};let r=[];for(let t of n.data.list){if(e.get(String(t.id)))return logger.mark(`${this.e.logFnc}[UID:${this.uid}] 获取${this.typeName}记录完成，暂无新记录`),{hasErr:!1,list:r};r.push(t),a=t.id}++i%3==0?await s(500):await s(300);let l=await this.getAllLog(e,t,i,a);return r=r.concat(l.list),{hasErr:l.hasErr,list:r}}readJson(){let e=[],t=new Map,i=`${this.path}/${this.uid}/${this.type}.json`;if(a.existsSync(i)){e=JSON.parse(a.readFileSync(i,"utf8"));for(let i of e)i.id&&t.set(String(i.id),i.id)}return{list:e,ids:t}}creatFile(){if(a.existsSync(this.path)||a.mkdirSync(this.path),!this.uid)return;let e=`${this.path}${this.uid}/`;a.existsSync(e)||a.mkdirSync(e)}writeJson(e){this.creatFile();let t=`${this.path}${this.uid}/`;a.writeFileSync(`${t}${this.type}.json`,JSON.stringify(e,"","\t"))}async getLogData(){return await this.getUid(),!!this.uid&&(this.e?.isAll?await this.getAllGcLogData():await this.getGcLogData())}async getAllGcLogData(){this.model="gachaAllLog";const e=["角色",this.e?.isSr?"光锥":"武器","集录","常驻"],t=[];let i=0;const a=this.e.msg;for(let a of e){this.e.msg=a,this.all=[];let e=await this.getGcLogData();e&&0!==e.allNum&&(i<=e.fiveLog.length&&(i=e.fiveLog.length),e.max="武器"===a||"光锥"===a?80:90,t.push(e))}if(0===t.length)return this.e.reply(`暂无抽卡记录\n${this.e?.isSr?"*":"#"}记录帮助，查看配置说明`,!1,{at:!0}),!0;for(let e of t){let t=i-e.fiveLog.length;t>0&&(e.fiveLog=e.fiveLog.concat(new Array(t).fill({isUp:!1,isNull:!0})))}const s={...t[0],data:t};return this.e.msg=a,s}async getGcLogData(){const{type:e,typeName:t}=this.getPool();this.isLogUrl||await this.updateLog();let i=this.analyse();return i.type=e,i.typeName=t,i=this.randData(i),i}getPool(){let e=this.e.msg.replace(/#|抽卡|记录|祈愿|分析|池|原神|星铁|崩坏星穹铁道|铁道/g,""),t=this.e.isSr?11:301,i="角色";switch(e){case"up":case"抽卡":case"角色":case"抽奖":t=this.e.isSr?11:301,i="角色";break;case"常驻":t=this.e.isSr?1:200,i="常驻";break;case"武器":t=this.e.isSr?12:302,i=this.e.isSr?"光锥":"武器";break;case"集录":t=500,i="集录";break;case"光锥":t=12,i="光锥";break;case"新手":t=this.e.isSr?2:100,i="新手"}return this.type=t,this.typeName=i,{type:t,typeName:i}}async getUid(){if(!a.existsSync(this.path))return this.e.reply(`暂无抽卡记录\n${this.e?.isSr?"*":"#"}记录帮助，查看配置说明`,!1,{at:!0}),!1;let e=a.readdirSync(this.path);if(i.isEmpty(e))return this.e.reply(`暂无抽卡记录\n${this.e?.isSr?"*":"#"}记录帮助，查看配置说明`,!1,{at:!0}),!1;if(this.uid||(this.e.at=!1,this.uid=this?.e?.isSr?this.e.user?._games?.sr?.uid:this.e.user?._games?.gs?.uid||await this.e.runtime.getUid(this.e)||await redis.get(this.uidKey)),this.uid&&e.includes(String(this.uid)))return this.uid;let t=[];for(let i of e){let e=this?.e?.isSr?`${this.path}${i}/11.json`:`${this.path}${i}/301.json`;if(!a.existsSync(e))continue;let s=a.statSync(e);t.push({uid:i,mtimeMs:s.mtimeMs})}return!(t.length<=0)&&(t=t.sort((function(e,t){return t.mtimeMs-e.mtimeMs})),this.uid=t[0].uid,t[0].uid)}analyse(){i.isEmpty(this.all)&&(this.all=this.readJson().list);let e=[],t=[],a=0,s=0,n=0,l=0,u=0,h=0,m=0,g=0,c=0,p=this.all.length,d=0,y=this.e?.game;for(let i of this.all){if(this.role=i,4==i.rank_type&&(s++,0==h&&(h=l),l=0,t[i.name]?t[i.name]++:t[i.name]=1,"武器"!=i.item_type&&"光锥"!=i.item_type||c++),l++,5==i.rank_type){a++,e.length>0?e[e.length-1].num=n:u=n,n=0;let t=!1;"角色"==i.item_type?this.checkIsUp()?t=!0:m++:g++,e.push({name:i.name,icon:o.getIcon(i.name,i.item_type,y),abbrName:r.shortName(i.name),item_type:i.item_type,num:0,isUp:t})}n++}if(e.length>0){e[e.length-1].num=n;for(let t in e)if("未知"==e[t].name)p-=e[t].num,e.splice(t,1),a--;else{let i=Number(t)+1;e[i]&&!e[i].isUp?(e[t].minimum=!0,d++):e[t].minimum=!1}}else u=p;let f=[];for(let e in t)f.push({name:e,num:t[e]});f=f.sort(((e,t)=>t.num-e.num)),f.length<=0&&f.push({name:"无",num:0});let b=0,w=0;a>0&&(b=Math.round((p-u)/a)),s>0&&(w=Math.round((p-h)/s));let N=0;a>0&&a>m&&(N=e.length>0&&!e[0].isUp?Math.round((p-u-e[0].num)/(a-m)):Math.round((p-u)/(a-m)));let _=160*N;_=_>=1e4?(_/1e4).toFixed(2)+"w":_.toFixed(0);let S=0;a>0&&(S=(a-d-m)/(a-d),S=(100*S).toFixed(1));let v=this.all[this.all.length-1]?.time.substring(0,16),$=this.all[0]?.time.substring(0,16);return{allNum:p,noFiveNum:u,noFourNum:h,fiveNum:a,fourNum:s,fiveAvg:b,fourAvg:w,wai:m,isvalidNum:N,maxFour:f[0],weaponNum:g,weaponFourNum:c,firstTime:v,lastTime:$,fiveLog:e,upYs:_,noWaiRate:S}}checkIsUp(){if(["莫娜","七七","迪卢克","琴","姬子","杰帕德","彦卿","白露","瓦尔特","克拉拉","布洛妮娅"].includes(this.role.name))return!1;let e={"刻晴":{start:"2021-02-17 18:00:00",end:"2021-03-02 15:59:59"},"提纳里":{start:"2022-08-24 06:00:00",end:"2022-09-09 17:59:59"},"迪希雅":{start:"2023-03-01 06:00:00",end:"2023-03-21 17:59:59"}};if(i.keys(e).includes(this.role.name)){let t=new Date(e[this.role.name].start).getTime(),i=new Date(e[this.role.name].end).getTime(),a=new Date(this.role.time).getTime();return!(a<t||a>i)}return!0}randData(e){const t=e.type||this.type,i=e.typeName||this.typeName,a=12===t||302===t?80:90;let s,n,r=[],l=this.e.isSr?"光锥":"武器";if(e&&e.fiveLog){const t=e.fiveLog.filter((e=>0!==e.num));t.length>0?(s=Math.max(...t.map((e=>e.num))),n=Math.min(...t.map((e=>e.num)))):e.fiveLog[0]?(s=e.fiveLog[0],n=e.fiveLog[0]):(s=0,n=0)}else s=0,n=0;[301,11].includes(t)&&(r=[[{lable:"未出五星",num:e.noFiveNum,unit:"抽"},{lable:"五星",num:e.fiveNum,unit:"个"},{lable:"五星平均",num:e.fiveAvg,unit:"抽",color:e.fiveColor},{lable:"小保底不歪",num:e.noWaiRate+"%",unit:""},{lable:"最非",num:s,unit:"抽"}],[{lable:"未出四星",num:e.noFourNum,unit:"抽"},{lable:"五星常驻",num:e.wai,unit:"个"},{lable:"UP平均",num:e.isvalidNum,unit:"抽"},{lable:"UP花费"+(this?.e?.isSr?"星琼":"原石"),num:e.upYs,unit:""},{lable:"最欧",num:n,unit:"抽"}]]),[200,1].includes(t)&&(r=[[{lable:"未出五星",num:e.noFiveNum,unit:"抽"},{lable:"五星",num:e.fiveNum,unit:"个"},{lable:"五星平均",num:e.fiveAvg,unit:"抽",color:e.fiveColor},{lable:`五星${l}`,num:e.weaponNum,unit:"个"},{lable:"最非",num:s,unit:"抽"}],[{lable:"未出四星",num:e.noFourNum,unit:"抽"},{lable:"四星",num:e.fourNum,unit:"个"},{lable:"四星平均",num:e.fourAvg,unit:"抽"},{lable:"四星最多",num:e.maxFour.num,unit:e.maxFour.name.slice(0,4)},{lable:"最欧",num:n,unit:"抽"}]]),[302,12].includes(t)&&(r=[[{lable:"未出五星",num:e.noFiveNum,unit:"抽"},{lable:"五星",num:e.fiveNum,unit:"个"},{lable:"五星平均",num:e.fiveAvg,unit:"抽",color:e.fiveColor},{lable:`四星${l}`,num:e.weaponFourNum,unit:"个"},{lable:"最非",num:s,unit:"抽"}],[{lable:"未出四星",num:e.noFourNum,unit:"抽"},{lable:"四星",num:e.fourNum,unit:"个"},{lable:"四星平均",num:e.fourAvg,unit:"抽"},{lable:"四星最多",num:e.maxFour.num,unit:e.maxFour.name.slice(0,4)},{lable:"最欧",num:n,unit:"抽"}]]),[500].includes(t)&&(r=[[{lable:"未出五星",num:e.noFiveNum,unit:"抽"},{lable:"五星",num:e.fiveNum,unit:"个"},{lable:"五星平均",num:e.fiveAvg,unit:"抽",color:e.fiveColor},{lable:`四星${l}`,num:e.weaponFourNum,unit:"个"},{lable:"最非",num:s,unit:"抽"}],[{lable:"未出四星",num:e.noFourNum,unit:"抽"},{lable:"四星",num:e.fourNum,unit:"个"},{lable:"四星平均",num:e.fourAvg,unit:"抽"},{lable:"四星最多",num:e.maxFour.num,unit:e.maxFour.name.slice(0,4)},{lable:"最欧",num:n,unit:"抽"}]]),[100,2].includes(t)&&(r=[[{lable:"未出五星",num:e.noFiveNum,unit:"抽"},{lable:"五星",num:e.fiveNum,unit:"个"},{lable:"五星平均",num:e.fiveAvg,unit:"抽",color:e.fiveColor},{lable:`五星${l}`,num:e.weaponNum,unit:"个"},{lable:"最非",num:s,unit:"抽"}],[{lable:"未出四星",num:e.noFourNum,unit:"抽"},{lable:"四星",num:e.fourNum,unit:"个"},{lable:"四星平均",num:e.fourAvg,unit:"抽"},{lable:"四星最多",num:e.maxFour.num,unit:e.maxFour.name.slice(0,4)},{lable:"最欧",num:n,unit:"抽"}]]);return{...this.screenData,saveId:this.uid,uid:this.uid,type:t,typeName:i,allNum:e.allNum,firstTime:e.firstTime,lastTime:e.lastTime,fiveLog:e.fiveLog,line:r,hasMore:!1,max:a}}getServer(){switch(String(this.uid).slice(0,-8)){case"1":case"2":return this.e.isSr?"prod_gf_cn":"cn_gf01";case"5":return this.e.isSr?"prod_qd_cn":"cn_qd01";case"6":return this.e.isSr?"prod_official_usa":"os_usa";case"7":return this.e.isSr?"prod_official_euro":"os_euro";case"8":case"18":return this.e.isSr?"prod_official_asia":"os_asia";case"9":return this.e.isSr?"prod_official_cht":"os_cht"}return"cn_gf01"}}export{o as default};
