import t from"./base.js";import{MysInfo as e,MysApi as a,GSCfg as i}from"yunzai-mys";import r from"lodash";import s from"moment";import o from"node:fs";import{sleep as n}from"yunzai";class h extends t{constructor(t){super(t),this.e=t,this.model="ledger",this.e.msg?.includes("星琼")&&(this.e.isSr=!0),this.color=["#73a9c6","#d56565","#70b2b4","#bd9a5a","#739970","#7a6da7","#597ea0"],this.action={other:0,adventure_reward:1,space_reward:2,daily_reward:3,abyss_reward:4,mail_reward:5,event_reward:6}}async get(){if(this.getMonth(),!this.month)return;let t=await e.get(this.e,"ys_ledger",{month:this.month});if(!t||0!==t.retcode)return!1;this.e.nowData=t.data;let a=this.dealData(t.data);return this.saveLedger(this.e.uid),a}getMonth(){let t=this.e.msg.replace(/#|原石|月|札记|星铁|星琼/g,""),e=Number(s().month())+1,a=["一","二","三","四","五","六","七","八","九","十","十一","十二"];if(t){if(isNaN(t)){for(let e in a)if(t==a[e]){t=Number(e)+1;break}isNaN(t)&&(t=e)}}else t=e;if((t<1||t>12)&&(t=e),![11,12,1,2,3,4,5,6,7,8,9,10,11,12].splice(e-1,3).includes(Number(t)))return this.e.reply("札记仅支持查询最近三个月的数据"),!1;(e>=3&&t>e||e<3&&t>e&&t<=9+t)&&(t=e),this.e.isSr?(this.NowMonth=s().year().toString()+(e<10?"0":"")+e.toString(),this.month=s().year().toString()+(t<10?"0":"")+t.toString(),this.srmonth=t):(this.NowMonth=e,this.month=t)}dealData(t){let e;e=this.month==this.NowMonth?`${this[this.e.isSr?"srmonth":"month"]}月${s().date()}号`:`${this[this.e.isSr?"srmonth":"month"]}月`;let a=this.e.isSr?"current_hcoin":"current_primogems",i=this.e.isSr?"last_hcoin":"last_primogems",n=this.e.isSr?"current_rails_pass":"current_mora",h=this.e.isSr?"last_rails_pass":"last_mora";t.month_data.gacha=(t.month_data[a]/160).toFixed(0),t.month_data.last_gacha=(t.month_data[i]/160).toFixed(0),t.month_data[a]>1e4&&(t.month_data[a]=(t.month_data[a]/1e4).toFixed(2)+" w"),t.month_data[i]>1e4&&(t.month_data[i]=(t.month_data[i]/1e4).toFixed(2)+" w"),t.month_data[n]>1e4&&(t.month_data[n]=(t.month_data[n]/1e4).toFixed(1)+" w"),t.month_data[h]>1e4&&(t.month_data[h]=(t.month_data[h]/1e4).toFixed(1)+" w"),t.day_data[a]>1e4&&(t.day_data[a]=(t.day_data[a]/1e4).toFixed(1)+" w"),t.day_data[n]>1e4&&(t.day_data[n]=(t.day_data[n]/1e4).toFixed(1)+" w"),t.color=[],t.month_data.group_by.forEach((e=>{this.e.isSr?(e.color=this.color[this.action[e.action]],e.action_name=e.action_name.slice(0,4)):e.color=this.color[e.action_id],t.color.push(e.color)})),t.group_by=JSON.stringify(t.month_data.group_by),t.color=JSON.stringify(t.color);let l="";this.e.isSr&&(l=r.sample(o.readdirSync(`${this._path}/plugins/genshin/resources/StarRail/img/role`).filter((t=>t.endsWith(".webp")))));return{saveId:this.e.uid,uid:this.e.uid,day:e,icon:l,srday:`${["星期日","星期一","星期二","星期三","星期四","星期五","星期六"][s().day()]}`,nowDay:s(new Date).format("YYYY年MM月DD日"),...t,...this.screenData}}async saveLedger(t,a="",i=!1){if(a?t=a.uid:a=await e.checkUidBing(t,this.e.isSr?"sr":"gs"),!a||r.isEmpty(a))return!1;let h=`./data/${this.e?.isSr?"SR_NoteData":"NoteData"}/${t}.json`,l={};o.existsSync(h)&&(l=JSON.parse(o.readFileSync(h,"utf8")));let m=Number(s().year()),d=Number(s().month())+1,c=[11,12,1,2,3,4,5,6,7,8,9,10,11,12].splice(d-1,3);for(let t of c){let e,r=m;if(d<=2&&t>=11&&r--,l[r]||(l[r]={}),!l[r][t]||d==t||!l[r][t].isUpdate){if(d==t&&this.e.nowData&&this.e.nowData?.data?.data_month==d)e=this.e.nowData;else{let s=t;if(this.e.isSr&&(s=String(r)+(t<10?"0":"")+String(t)),e=await this.ysLedger(a,s,i),!e)continue}d!=t&&(e.isUpdate=!0),l[r][t]=e,n(100)}}return logger.mark(`[札记查询][自动保存] uid:${t} 数据已保存`),o.writeFileSync(h,JSON.stringify(l,"","\t")),l}async ysLedger(t,i,r){let s={};if(r){let o=new a(t.uid,t.ck,{log:!1},this.e?.isSr);s=await o.getData("ys_ledger",{month:i}),s=await new e(this.e).checkCode(s,"ys_ledger",o,{month:i},r)}else s=await e.get(this.e,"ys_ledger",{month:i});return!(!s||0!=s.retcode)&&s.data}async ledgerTask(t){let e=(await i.getBingCk(this.e?.isSr?"sr":"gs")).ck,a=r.map(e,"uid"),o=s().add(.7*a.length,"s").format("MM-DD HH:mm:ss");logger.mark(`${this.e?.isSr?"开拓月历":"札记"}ck:${a.length}个，预计需要${this.countTime(a.length)} ${o} 完成`),t&&(await this.e.reply(`开始任务：保存${this.e?.isSr?"星琼":"原石"}数据，完成前请勿重复执行`),await this.e.reply(`${this.e?.isSr?"开拓月历":"札记"}ck：${a.length}个\n预计需要：${this.countTime(a.length)}\n完成时间：${o}`));for(const t of a){const a=e[t];await this.saveLedger(t,a,!0),await n(500)}t&&this.e.reply((this.e?.isSr?"星琼":"原石")+"任务完成")}countTime(t){let e=.7*t,a=Math.floor(e/3600%24),i=Math.floor(e/60%60),r=Math.floor(e%60),s="";return a>0&&(s+=`${a}小时`),i>0&&(s+=`${i}分钟`),r>0&&(s+=`${r}秒`),s}async ledgerCount(){this.model="ledgerCount";let t=await e.init(this.e,"ys_ledger"),a=t?.uid;if(!a)return!1;let i=await this.saveLedger(a);return this.ledgerCountData(i)}async ledgerCountHistory(){let t;t=this.e.msg.includes("去年")?s().year()-1:this.e.msg.includes("今年")?s().year():this.e.msg.match(/(\d{4})/),t&&(t=parseInt(t)),t||(t=s().year()),this.model="ledgerCount";let a=await e.init(this.e,"ys_ledger"),i=a?.uid;if(!i)return!1;let n=`./data/${this.e?.isSr?"SR_NoteData":"NoteData"}/${i}.json`,h={};return o.existsSync(n)&&(h=JSON.parse(o.readFileSync(n,"utf8"))),!h||r.isEmpty(h)?(this.e.reply(this.e?.isSr?["暂无星琼数据，请先发送 *星琼",segment.button([{text:"星琼",input:"*星琼"}])]:["暂无原石数据，请先发送 #原石",segment.button([{text:"原石",input:"#原石"}])],!1,{at:!0}),!1):(h=h[t],h?(r.forEach(h,(e=>{e.year=t})),this.ledgerCountData(h,String(t))):(this.e.reply(`uid：${i} ${t}年无${this.e?.isSr?"星琼":"原石"}统计数据！`,!1,{at:!0}),!1))}ledgerCountData(t,e){let a,i=!1;if(e)a=`${e}年-`;else{if(t&&Object.keys(t)&&Object.keys(t).length>0){let e=0;Object.keys(t).forEach((a=>{let i=t[a];e+=Object.keys(i).length})),i=e>=12}const e=[];for(let a=0;a<12;a++){let i=Number(s().month())+1-a,r=Number(s().year());i<=0&&(i=12+i,r--),t[r]&&t[r][i]&&(t[r][i].year=r,e.push(t[r][i]))}t=e}if(!t||r.isEmpty(t))return;let o={allPrimogems:0,allMora:0,primogemsMonth:[],moraMonth:[],yearText:a},n=this.e.isSr?"current_hcoin":"current_primogems",h=this.e.isSr?"current_rails_pass":"current_mora";r.forEach(t,(t=>{o.allPrimogems+=t.month_data[n],o.allMora+=t.month_data[h],this.e.isSr&&(t.data_month="0"==t.data_month.slice(-2,-1)?t.data_month.slice(-1):t.data_month.slice(-2)),o.primogemsMonth.push({value:t.month_data[n],month:String(t.data_month),year:String(t.year),name:this.e.isSr?"星琼":"原石"}),o.moraMonth.push({value:(t.month_data[h]/1e3).toFixed(0),month:String(t.data_month),year:String(t.year),name:this.e.isSr?"专&通票":"摩拉"})})),o.allPrimogemsShow=(o.allPrimogems/1e4).toFixed(2)+"w",o.allGacha=(o.allPrimogems/160).toFixed(0),this.e.isSr?(o.allGacha=(o.allPrimogems/160+o.allMora).toFixed(0),o.allMora=o.allMora.toFixed(0)+"张"):o.allMora=(o.allMora/1e4).toFixed(0)+"w",o.maxPrimogems=r.maxBy(o.primogemsMonth,"value"),o.maxMora=r.maxBy(o.moraMonth,"value"),o.primogemsMonth=r.sortBy(o.primogemsMonth,(t=>100*Number(t.year)+Number(t.month)));let l=r(t).map("month_data").map("group_by").flatMap().value();this.e.isSr&&l.forEach((t=>{t.action_id=this.action[t.action],t.action=t.action_name.slice(0,4)}));let m={};for(let t of l)m[t.action]?m[t.action].num+=t.num:m[t.action]={num:t.num,action:t.action,action_id:t.action_id};return m=r.flatMap(m,(t=>t)),m=r.orderBy(m,["num"],["desc"]),o.color=[],m.forEach((t=>{o.color.push(this.color[t.action_id])})),o.group_by=m,o.color=JSON.stringify(o.color),o.pieData=JSON.stringify(m),o.primogemsMonth=JSON.stringify(o.primogemsMonth),o.hasMore=i,{saveId:this.e.uid,uid:this.e.uid,...o,...this.screenData}}}export{h as default};
