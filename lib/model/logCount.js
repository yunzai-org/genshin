import e from"./base.js";import t from"lodash";import s from"node:fs";import{gsCfg as i}from"yunzai-mys";import r from"moment";import a from"./gachaLog.js";class o extends e{constructor(e){super(e),this.model="logCount",this.urlKey=`${this.prefix}url:`,this.uidKey=`Yz:genshin:mys:qq-uid:${this.userId}`,this.path=`./data/gachaJson/${this.e.user_id}/`,this.pool=[{type:301,typeName:"角色"},{type:302,typeName:"武器"},{type:500,typeName:"集录"},{type:200,typeName:"常驻"}],this.role5=["刻晴","莫娜","七七","迪卢克","琴","提纳里","迪希雅"],this.weapon5=["阿莫斯之弓","天空之翼","天空之卷","天空之脊","天空之傲","天空之刃","四风原典","和璞鸢","狼的末路","风鹰剑"],e.isSr&&(this.uidKey=`Yz:srJson:mys:qq-uid:${this.userId}`,this.path=`./data/srJson/${this.e.user_id}/`,this.pool=[{type:11,typeName:"角色"},{type:12,typeName:"光锥"},{type:1,typeName:"常驻"},{type:2,typeName:"新手"}],this.role5=["姬子","杰帕德","彦卿","白露","瓦尔特","克拉拉","布洛妮娅"],this.weapon5=["银河铁道之夜","无可取代的东西","但战斗还未结束","以世界之名","制胜的瞬间","如泥酣眠","时节不居"])}readJson(){let e=[],t=[],i=`${this.path}/${this.uid}/${this.type}.json`;if(s.existsSync(i)){e=JSON.parse(s.readFileSync(i,"utf8"));for(let s of e)s.id&&t.push(s.id)}return{list:e,ids:t}}async count(){if(this.getPool(),await this.getUid(),!this.uid)return await this.e.reply("当前绑定uid暂无抽卡记录"),!1;let e=this.analyseHistory();return!!e&&{quality:80,...this.screenData,...e}}getPool(){let e=this.e.msg.replace(/#|抽卡|记录|祈愿|分析|池|原神|星铁|崩坏星穹铁道|铁道|抽卡|统计|池/g,"");switch(this.type=this.e.isSr?11:301,this.typeName="角色",e){case"up":case"抽卡":case"角色":case"抽奖":this.type=this.e.isSr?11:301,this.typeName="角色";break;case"常驻":this.type=this.e.isSr?1:200,this.typeName="常驻";break;case"集录":this.type=500,this.typeName="集录";break;case"武器":this.type=this.e.isSr?12:302,this.typeName=this.e.isSr?"光锥":"武器";break;case"光锥":this.type=12,this.typeName="光锥";break;case"新手":this.type=this.e.isSr?2:100,this.typeName="新手"}}async getUid(){if(!s.existsSync(this.path))return this.e.reply(`暂无抽卡记录\n${this.e?.isSr?"*":"#"}记录帮助，查看配置说明`,!1,{at:!0}),!1;let e=s.readdirSync(this.path);if(t.isEmpty(e))return this.e.reply(`暂无抽卡记录\n${this.e?.isSr?"*":"#"}记录帮助，查看配置说明`,!1,{at:!0}),!1;if(this.uid||(this.e.at=!1,this.uid=this?.e?.isSr?this.e.user?._games?.sr?.uid:this.e.user?._games?.gs?.uid||await this.e.runtime.getUid(this.e)||await redis.get(this.uidKey)),this.uid&&e.includes(String(this.uid)))return this.uid;let i=[];for(let t of e){let e=`${this.path}${t}/301.json`;if(!s.existsSync(e))continue;let r=s.statSync(e);i.push({uid:t,mtimeMs:r.mtimeMs})}return!(i.length<=0)&&(i=i.sort((function(e,t){return t.mtimeMs-e.mtimeMs})),this.uid=i[0].uid,i[0].uid)}getPoolCfg(){let e=i.getdefSet("pool",this.type);return e.forEach((e=>{e.start=r(e.from,"YYYY-MM-DD HH:mm:ss").format("X"),e.end=r(e.to,"YYYY-MM-DD HH:mm:ss").format("X")})),e}analyseHistory(){let e=this.readJson().list,s=this.e?.game;e=e.reverse();let o,n=[...this.getPoolCfg()].reverse();o=301==this.type?i.getdefSet("role","other").sortName:i.getdefSet("weapon","other").sortName;let h={},m=0,p=0;for(let t of e){let e=r(t.time).format("X");e:for(let i in n){if(e>=n[i].start&&e<=n[i].end){h[n[i].start]?h[n[i].start].count++:h[n[i].start]={count:1,list:[],name:n[i].name,five:n[i].five,start:r(n[i].from,"YYYY-MM-DD HH:mm:ss").format("YYYY-MM-DD"),end:r(n[i].to,"YYYY-MM-DD HH:mm:ss").format("YYYY-MM-DD")},5==t.rank_type?("未知"!=t.name&&h[n[i].start].list.push({name:t.name,icon:a.getIcon(t.name,t.item_type,s),rank_type:t.rank_type,item_type:t.item_type,time:e,num:m+1}),m=0,p++):4==t.rank_type?(h[n[i].start].list.push({name:t.name,icon:a.getIcon(t.name,t.item_type,s),rank_type:t.rank_type,item_type:t.item_type,time:e,num:p+1}),p=0,m++):(m++,p++);break e}delete n[i]}}let l=[];for(let e in h)l.push(h[e]);if(h=l.reverse(),h.length<=0)return!1;let y=0,u=[];for(let e in h){y++,h[e].role={},h[e].five=h[e].five.map((e=>o[e]??e)).join("、");for(let t of h[e].list)h[e].role[t.name]?h[e].role[t.name].count++:h[e].role[t.name]={name:t.name,icon:a.getIcon(t.name,t.item_type,s),rank_type:t.rank_type,item_type:t.item_type,count:1};delete h[e].list;for(let t in h[e].role){let s=1e3*(h[e].role[t].rank_type-3)+h[e].role[t].count;this.role5.includes(h[e].role[t].name)&&s--,this.weapon5.includes(h[e].role[t].name)&&s--,"角色"==h[e].role[t].item_type&&5==h[e].role[t].rank_type&&(s+=1e3),h[e].role[t].sort=s}if(h[e].roleNum=Object.keys(h[e].role).length,h[e].role=t.orderBy(h[e].role,["sort"],["desc"]),u.push(h[e]),y+=Math.ceil(h[e].roleNum/6),this.e.isGroup&&y>=12)break}return{saveId:this.uid,uid:this.uid,pool:u,typeName:this.typeName,isGroup:this.e.isGroup}}}export{o as default};
