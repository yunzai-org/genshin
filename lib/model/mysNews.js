import t from"./base.js";import e from"node-fetch";import s from"lodash";import*as i from"yunzai";import{puppeteer as a,sleep as r}from"yunzai";import{gsCfg as o}from"yunzai-mys";import n from"yaml";import c from"fs";let p;class l extends t{constructor(t){super(t),this.model="mysNews"}async getNews(t){let e=1,s="公告";this.e.msg.includes("资讯")&&(e="3",s="资讯"),this.e.msg.includes("活动")&&(e="2",s="活动");const i=await this.postData("getNewsList",{gids:t,page_size:this.e.msg.includes("列表")?5:20,type:e});if(!i)return;const a=i.data.list;if(0==a.length)return!0;let r={},o=this.game(t);if(this.e.msg.includes("列表"))this.model="mysNews-list",a.forEach((t=>{t.post.created_at=new Date(1e3*t.post.created_at).toLocaleString()})),r={...this.screenData,saveId:this.e.user_id,data:a,game:o,typeName:s};else{const e=this.e.msg.replace(/#|＃|官方|星铁|原神|崩坏三|崩三|绝区零|崩坏二|崩二|崩坏学园二|未定|未定事件簿|公告|资讯|活动/g,"").trim()||1;if(e>a.length)return await this.e.reply("目前只查前20条最新的公告，请输入1-20之间的整数。"),!0;const s=a[e-1].post.post_id;r=await this.newsDetail(s,t)}const n=await this.render(r);return this.replyMsg(n,`${o}${s}：${r?.data?.post?.subject||`米游社${o}${s}列表`}`)}render(t){return a.screenshots(this.model,t)}async newsDetail(t,e){const s=await this.postData("getPostFull",{gids:e,read:1,post_id:t});if(!s)return;const i=await this.detalData(s.data.post,e);return{...this.screenData,saveId:t,dataConent:i.post.content,data:i}}postApi(t,e){let i="https://bbs-api.miyoushe.com/",a=[];switch(s.forEach(e,((t,e)=>a.push(`${e}=${t}`))),a=a.join("&"),t){case"searchPosts":i="https://bbs-api.miyoushe.com/post/wapi/searchPosts?";break;case"userInstantSearchPosts":i="https://bbs-api.miyoushe.com/painter/api/user_instant/search/list?";break;case"getPostFull":i+="post/wapi/getPostFull?";break;case"getNewsList":i+="post/wapi/getNewsList?";break;case"emoticon":i+="misc/api/emoticon_set?"}return i+a}async postData(t,s){const i=this.postApi(t,s),a={Referer:"https://www.miyoushe.com","User-Agent":"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.0.0 Safari/537.36"};let r;try{r=await e(i,{method:"get",headers:a})}catch(t){return logger.error(t.toString()),!1}if(!r.ok)return logger.error(`[米游社接口错误][${t}] ${r.status} ${r.statusText}`),!1;return await r.json()}async detalData(t,e){let s;try{s=JSON.parse(t.post.content)}catch(t){}if("object"==typeof s){if(s.imgs&&s.imgs.length>0)for(const e of s.imgs)t.post.content=` <div class="ql-image-box"><img src="${e}?x-oss-process=image//resize,s_600/quality,q_80/auto-orient,0/interlace,1/format,png"></div>`}else{for(const e of t.post.images)t.post.content=t.post.content.replace(e,e+"?x-oss-process=image//resize,s_600/quality,q_80/auto-orient,0/interlace,1/format,jpg");p||(p=await this.mysEmoticon(e)),t.post.content=t.post.content.replace(/_\([^)]*\)/g,(function(t,e){return t=t.replace(/_\(|\)/g,""),p.has(t)?`<img class="emoticon-image" src="${p.get(t)}"/>`:""}));const s={lt:"<",gt:">",nbsp:" ",amp:"&",quot:'"'};t.post.content=t.post.content.replace(/&(lt|gt|nbsp|amp|quot);/gi,(function(t,e){return s[e]}))}t.post.created_time=new Date(1e3*t.post.created_at).toLocaleString();for(const e in t.stat)t.stat[e]=t.stat[e]>1e4?(t.stat[e]/1e4).toFixed(2)+"万":t.stat[e];return t}async mysEmoticon(t){const e=new Map,s=await this.postData("emoticon",{gids:t});if(0!=s.retcode)return e;for(const t of s.data.list)if(t.icon)for(const s of t.list)s.icon&&e.set(s.name,s.icon);return e}async mysSearch(){let t=this.e.msg;if(t=t.replace(/#|米游社|mys/g,""),!t)return await this.e.reply("请输入关键字，如#米游社七七"),!1;let e=t.match(/.*(\d){1}$/)||0;e&&e[1]&&(e=e[1]),t=s.trim(t,e);let i=await this.postData("searchPosts",{gids:2,size:20,keyword:t});if(!i)return;if(i?.data?.posts.length<=0)return await this.e.reply("搜索不到您要的结果，换个关键词试试呗~"),!1;let a=i.data.posts[e].post.post_id;const r=await this.newsDetail(a),o=await this.render(r);return this.replyMsg(o,`${r.data.post.subject}`)}async mysUrl(){let t=this.e.msg,e=/[0-9]+/g.exec(t)[0];if(!e)return!1;const s=await this.newsDetail(e),i=await this.render(s);return this.replyMsg(i,`${s.data.post.subject}`)}async mysEstimate(t,e){let s=await this.postData("userInstantSearchPosts",{keyword:t,uid:e,size:20,offset:0,sort_type:2}),i=s?.data?.list;if(i.length<=0)return await this.e.reply("暂无数据"),!1;let a=i[0].post.post.post_id;if(!a)return await this.e.reply("暂无数据"),!1;const r=await this.newsDetail(a),o=await this.render(r);return o.length>1&&o.push(segment.image(r.data.post.images[0]+"?x-oss-process=image//resize,s_600/quality,q_80/auto-orient,0/interlace,1/format,jpg")),this.replyMsg(o,`${r.data.post.subject}`)}replyMsg(t,e){return!(!t||t.length<=0)&&(e&&(t=[e,...t]),t.length<=2?t:i.makeForwardMsg(this.e,[t]))}async mysNewsTask(){let t=o.getConfig("mys","pushNews");this.maxNum=t.maxNum;for(let e of[1,2,3,4,6,8]){let i=1==e?"bbb":2==e?"gs":3==e?"bb":4==e?"wd":6==e?"sr":"zzz",a=[];if(!s.isEmpty(t[`${i}announceGroup`])){let t=await this.postData("getNewsList",{gids:e,page_size:10,type:1});t&&t.data.list.forEach((t=>{a.push({...t,typeName:"公告",post_id:t.post.post_id})}))}if(!s.isEmpty(t[`${i}infoGroup`])){let t=await this.postData("getNewsList",{gids:e,page_size:10,type:3});t&&t.data.list.forEach((t=>{a.push({...t,typeName:"资讯",post_id:t.post.post_id})}))}if(a.length<=0)continue;a=s.orderBy(a,["post_id"],["asc"]);let r=Date.now()/1e3;this.key=`Yz:${i}:mys:newPush:`,this.e.isGroup=!0,this.pushGroup=[];for(let s of a)if(!(Number(r-s.post.created_at)>7200||t.banWord[i]&&new RegExp(t.banWord[i]).test(s.post.subject))){if("公告"==s.typeName)for(let a in t[`${i}announceGroup`])for(let r of t[`${i}announceGroup`][a])await this.sendNews(a,r,s.typeName,s.post.post_id,e);if("资讯"==s.typeName)for(let a in t[`${i}infoGroup`])for(let r of t[`${i}infoGroup`][a])await this.sendNews(a,r,s.typeName,s.post.post_id,e)}}}async ActivityPush(){let t,e=new Date;if(e=e.getHours(),e<10)return;try{t=n.parse(c.readFileSync("./plugins/genshin/config/mys.pushNews.yaml","utf8"))}catch(t){return void logger.error(`[米游社活动到期推送] 活动到期预警推送失败：无法获取配置文件信息\n${t}`)}if(!(t.gsActivityPush&&t.gsActivityPush!={}||t.srActivityPush&&t.srActivityPush!={}))return;let s=[],i={...t.gsActivityPush,...t.srActivityPush};for(let t in i)s.push(t);let a=await this.getGsActivity(),o=await this.getSrActivity(),p=[];for(let t of o)p.push({game:"sr",subtitle:t.title,banner:t.img,title:t.title,end_time:t.end_time});for(let t of a)p.push({game:"gs",subtitle:t.subtitle,banner:t.banner,title:t.title,end_time:t.end_time});if(0!==p.length)for(let e of s){let s=await redis.get(`Yz:apgl:${e}`),a=await this.getDate();if(s=JSON.parse(s),s&&s.date===a||(s={date:a,GroupList:i[e]}),Array.isArray(s.GroupList)&&0!=s.GroupList.length)if(Bot[e]){for(let i of p){if(!(t.srActivityPush&&t.srActivityPush[e]&&t.srActivityPush[e].includes(s.GroupList[0])||"sr"!==i.game))continue;if(!(t.gsActivityPush&&t.gsActivityPush[e]&&t.gsActivityPush[e].includes(s.GroupList[0])||"gs"!==i.game))continue;let a;"sr"===i.game&&(a="星铁"),"gs"===i.game&&(a="原神");let o=i.end_time;o=o.replace(/\s/,"T");let n=new Date;o=new Date(o);let c=await this.calculateRemainingTime(n,o),p=[`【${a}活动即将结束通知】`,`\n活动:${i.subtitle}`,segment.image(i.banner),`描述:${i.title}`,`\n活动剩余时间:${c.days}天${c.hours}小时${c.minutes}分钟${c.seconds}秒`,`\n活动结束时间:${i.end_time}`];logger.mark(`[米游社活动到期推送] 开始推送 ${e}:${s.GroupList[0]} ${i.subtitle}`),await r(5e3),Bot[e].pickGroup(s.GroupList[0]).sendMsg(p).then((()=>{})).catch((t=>logger.error(`[米游社活动到期推送] ${e}:${s.GroupList[0]} 推送失败，错误信息${t}`)))}s.GroupList.shift(),await redis.set(`Yz:apgl:${e}`,JSON.stringify(s))}else s.GroupList.shift(),await redis.set(`Yz:apgl:${e}`,JSON.stringify(s))}}async getDate(){const t=new Date;return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`}async getGsActivity(){let t;try{t=await e("https://hk4e-api.mihoyo.com/common/hk4e_cn/announcement/api/getAnnList?game=hk4e&game_biz=hk4e_cn&lang=zh-cn&bundle_id=hk4e_cn&platform=pc&region=cn_gf01&level=55&uid=100000000"),t=await t.json()}catch{return[]}let s=[],i=[];for(let e of t.data.list[1].list)!e.tag_label.includes("活动")||e.title.includes("传说任务")||e.title.includes("游戏公告")||s.push(e);for(let t of s){let e=t.end_time;e=e.replace(/\s/,"T");let s=new Date;e=new Date(e),(await this.calculateRemainingTime(s,e)).days<=1&&i.push(t)}return i}async getSrActivity(){let t;try{t=await e("https://hkrpg-api.mihoyo.com/common/hkrpg_cn/announcement/api/getAnnList?game=hkrpg&game_biz=hkrpg_cn&lang=zh-cn&auth_appid=announcement&authkey_ver=1&bundle_id=hkrpg_cn&channel_id=1&level=65&platform=pc&region=prod_gf_cn&sdk_presentation_style=fullscreen&sdk_screen_transparent=true&sign_type=2&uid=100000000"),t=await t.json()}catch{return[]}let s=[],i=[];for(let e of t.data.pic_list[0].type_list[0].list)e.title&&s.push(e);for(let t of s){let e=t.end_time;e=e.replace(/\s/,"T");let s=new Date;e=new Date(e),(await this.calculateRemainingTime(s,e)).days<=1&&i.push(t)}return i}async calculateRemainingTime(t,e){const s=e-t;return{days:Math.floor(s/864e5),hours:Math.floor(s%864e5/36e5),minutes:Math.floor(s%36e5/6e4),seconds:Math.floor(s%6e4/1e3)}}async sendNews(t,e,i,a,o){if(this.pushGroup[e]||(this.pushGroup[e]=0),this.pushGroup[e]>=this.maxNum)return;if(await redis.get(`${this.key}${t}:${e}:${a}`))return;let n=this.game(o);if(this.e.group=Bot[t]?.pickGroup(e),!this.e.group)return void logger.mark(`[米游社${n}${i}推送] 群${t}:${e}未关联`);if(!this[a]){const t=await this.newsDetail(a,o);logger.mark(`[米游社${n}${i}推送] ${t.data.post.subject}`),this[a]={img:await this.render(t),title:t.data.post.subject}}this.pushGroup[e]++,await redis.set(`${this.key}${t}:${e}:${a}`,"1",{EX:36e3}),await r(s.random(1e4,9e4));const c=await this.replyMsg(this[a].img,`${n}${i}推送：${this[a].title}`);return this.e.group.sendMsg(c)}game(t){switch(t){case 1:return"崩坏三";case 2:return"原神";case 3:return"崩坏二";case 4:return"未定事件簿";case 6:return"崩坏星穹铁道";case 8:return"绝区零"}return""}}export{l as default};
