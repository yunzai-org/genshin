import{puppeteer as t}from"yunzai";import e from"node-fetch";import r from"moment";import a from"fs";import i from"./base.js";a.existsSync("./data/payLog/")||a.mkdirSync("./data/payLog/");class s{constructor(t=""){this.#t=encodeURIComponent(t)}#e="";#r=[];#t="";async getOringinalData(t=""){let r=await e(this.getUrl()+t,this.headers),a=await r.json(),i=this.checkResult(a);if(i?.errorMsg)return i;let s=a?.data?.list;return Array.isArray(s)?20===s.length?(this.#r.push(...s),await this.getOringinalData(s[19].id),!0):(this.#r.push(...s),!0):(console.error(a),{errorMsg:"获取失败，错误码："+a?.retcode})}async getPrimogemLog(t=""){let r=await e(this.getUrl("getPrimogemLog")+t,this.headers),a=await r.json(),i=this.checkResult(a);if(i?.errorMsg)return i;let s=a?.data?.list;return Array.isArray(s)?20===s.length?(s.forEach((t=>{"680"===t.add_num&&this.#r.push(t)})),await this.getPrimogemLog(s[19].id),!0):(s.forEach((t=>{"680"===t.add_num&&this.#r.push(t)})),!0):(console.error(a),{errorMsg:"获取失败，错误码："+a?.retcode})}async getUserInfo(){let t=await e(this.getUrl("getUserInfo"),this.headers),r=await t.json(),a=this.checkResult(r);if(a?.errorMsg)return a;let i=r?.data;return i?.uid?i:{errorMsg:"获取失败，可能是链接已过期或不正确"}}checkResult(t){return-101===t?.retcode||-100===t?.retcode?-101===t.retcode?{errorMsg:"您的链接过期，请重新获取"}:{errorMsg:"链接不正确，请重新获取"}:/unknown auth appid/.test(t?.message)?{errorMsg:"抽卡或其他链接现已无法获取充值记录，请发送客服页面的链接！"}:{errorMsg:""}}async filtrateData(){const t=await this.getUserInfo();if(t?.errorMsg)return t;this.#e=t.uid;let e=await this.getOringinalData();if(e?.errorMsg)return e;if(await this.getPrimogemLog(),0===this.#r.length)return{errorMsg:"未获取到您的任何充值数据"};this.#r=this.#r.sort(((t,e)=>{let r=Number(t.id);return Number(e.id)>r?-1:1}));const a=[680,300,8080,3880,2240,1090,330,60],i=[0,0,12960,6560,3960,1960,600,120];let s=0,n=0,o=-1,h=0,u=[];for(let t=0;t<this.#r.length;t++){let e=Number(this.#r[t].add_num);if(e<0)continue;let c=++r(this.#r[t].datetime).toArray()[1];c!==s?(o++,s=c,u[h++]={month:c+"月",payNum:[0,0,0,0,0,0,0,0]}):o||(u[o]={month:c+"月",payNum:[0,0,0,0,0,0,0,0]});for(let t=0;t<8;t++)if(e===a[t]||e===i[t]){u[o].payNum[t]++,680!==e&&(n+=e);break}}return{uid:this.#e,crystal:n,monthData:u}}headers={headers:{accept:"application/json, text/plain, */*","accept-language":"zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6","sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-site"},referrer:"https://webstatic.mihoyo.com/",referrerPolicy:"strict-origin-when-cross-origin",method:"GET",mode:"cors",credentials:"include"};getUrl(t="getCrystalLog"){const e="getUserInfo"===t,r=e?"/GetUserInfo":"getCrystalLog"===t?"/GetCrystalLog":"/GetPrimogemLog";let a="";return a+="?selfquery_type=1",a+="&sign_type=2",a+="&auth_appid=csc",a+="&authkey_ver=1",a+="&game_biz=hk4e_cn",a+="&win_direction=portrait",a+="&bbs_auth_required=true",a+="&bbs_game_role_required=hk4e_cn",a+="&app_client=bbs",a+="&lang=zh-cn",a+="&csc_authkey_required=true",a+="&authkey="+this.#t,a+="&page_id=1",e||(a+="&add_type=produce",a+="&size=20",a+="&end_id="),"https://hk4e-api.mihoyo.com/common/hk4e_self_help_query/User"+r+a}}class n extends i{constructor(t={}){super(),this.monthData=t.monthData,this.crystal=t.crystal,this.uid=t.uid,this.model="payLog"}crystal=0;uid="";monthData=[];price=[68,30,648,328,198,98,30,6];getBarData(){return this.monthData.map((t=>({type:t.month,sales:t.payNum.reduce(((t,e,r)=>t+e*this.price[r]),0)})))}getTopData(t=0){const e=this.maxcConsumption(),r=this.sumConsumption();return[{title:"总消费",value:"￥"+this.getBarData().reduce(((t,e)=>t+e.sales),0)},{title:"总结晶",value:this.crystal},{title:"消费最多",value:e.type},{title:e.type+"消费",value:"￥"+e.sales},...r]}getPieData(){const t=this.sumConsumption();let e=[];return t.forEach(((t,r)=>{let a=t.value*this.price[r];a&&e.push({value:a,name:t.title})})),e}maxcConsumption(){return this.getBarData().sort(((t,e)=>t.sales<e.sales?1:-1))[0]}sumConsumption(){let t={"小月卡":0,"大月卡":0,648:0,328:0,198:0,98:0,30:0,6:0},e=Object.keys(t).reverse();this.monthData.forEach((r=>{r.payNum.forEach(((r,a)=>{t[e[a]]+=r}))}));let r=Object.values(t).reverse();return e.map(((t,e)=>({title:t,value:r[e]})))}}async function o(e){const r=new n(e),a={...r.screenData,topData:r.getTopData(),barData:JSON.stringify(r.getBarData()),pieData:JSON.stringify(r.getPieData()),saveId:r.uid,uid:r.uid};return await t.screenshot("payLog",a)}export{n as HtmlData,s as PayData,o as renderImg};
