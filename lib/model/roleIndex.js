import e from"./base.js";import{gsCfg as t}from"yunzai-mys";import a from"lodash";import l from"moment";import r from"node:fs";import{Character as n}from"../miao.js";let s={};class i extends e{constructor(e){super(e),this.model="roleIndex",this.other=t.getdefSet("role","other"),this.wother=t.getdefSet("weapon","other"),this.lable=t.getdefSet("role","index"),this.area={"蒙德":1,"璃月":2,"雪山":3,"稻妻":4,"渊下宫":5,"层岩巨渊":6,"层岩地下":7,"须弥":8,"枫丹":9,"沉玉谷":10,"来歆山":11,"沉玉谷·南陵":12,"沉玉谷·上谷":13,"旧日之海":14},this.all_chest=0,a.forEach(this.lable,((e,t)=>{t.includes("_chest")&&(this.all_chest+=e)})),this.areaName=a.invert(this.area),this.headIndexStyle=`<style> .head_box { background: url(${this.screenData.pluResPath}img/roleIndex/namecard/${a.random(1,8)}.png) #f5f5f5; background-position-x: 30px; background-repeat: no-repeat; border-radius: 15px; font-family: tttgbnumber; padding: 10px 20px; position: relative; background-size: auto 101%; }</style>`}e;static async get(e){let t=new i(e);return await t.getIndex()}async getIndex(){let e=await MysInfo.get(this.e,{index:"",spiralAbyss:{schedule_type:1},character:"",basicInfo:""});if(!e||0!==e[0].retcode||0!==e[2].retcode)return!1;let t=[];return e.forEach((e=>t.push(e.data))),{quality:80,...this.screenData,...this.dealData(t)}}dealData(e){let[t,l,r,n]=e,s=r.avatars||[],i=s;for(let e in s){let t=s[e].rarity,a=s[e].actived_constellation_num,l=s[e].level,r=s[e].id-1e7;if(t>=5&&(t=5),t>5&&(r=0),10000002==s[e].id&&(r=50),10000005==s[e].id?(s[e].name="空",a=0,l=0):10000007==s[e].id&&(s[e].name="荧",a=0,l=0),s[e].sortLevel=l,s[e].sort=1e5*t+1e4*a+100*l+r,s[e].weapon.showName=this.wother.sortName[s[e].weapon.name]??s[e].weapon.name,s[e].costumesLogo="",s[e].costumes&&s[e].costumes.length>=1)for(let t of s[e].costumes)if(this.other.costumes.includes(t.name)){s[e].costumesLogo=2;break}}let u=t.stats||{},o=a.round((u.precious_chest_number+u.luxurious_chest_number+u.exquisite_chest_number+u.common_chest_number+u.magic_chest_number)/this.all_chest*100,1),m=(o<60?"D":o<70?"C":o<80?"B":o<90?"A":"S")+`[${o}%]`,h=[[{lable:"成就",num:u.achievement_number,extra:this.lable.achievement},{lable:"角色数",num:u.avatar_number,extra:this.lable.avatar},{lable:"等级",num:t?.role?.level??0,extra:this.lable.level},{lable:"总宝箱",num:u.precious_chest_number+u.luxurious_chest_number+u.exquisite_chest_number+u.common_chest_number+u.magic_chest_number,extra:this.all_chest},{lable:"获取率",num:m,color:"D"==m.substr(0,1)?"#12a182":"C"==m.substr(0,1)?"#2775b6":"B"==m.substr(0,1)?"#806d9e":"A"==m.substr(0,1)?"#c04851":"S"==m.substr(0,1)?"#f86b1d":""}],[{lable:"华丽宝箱",num:u.luxurious_chest_number,extra:this.lable.luxurious_chest},{lable:"珍贵宝箱",num:u.precious_chest_number,extra:this.lable.precious_chest},{lable:"精致宝箱",num:u.exquisite_chest_number,extra:this.lable.exquisite_chest},{lable:"普通宝箱",num:u.common_chest_number,extra:this.lable.common_chest}]],c=0;t.homes&&t.homes.length>0&&(c=t.homes[0].level);let b=a.keyBy(t.world_explorations,"id"),_=[],d=[],f=["枫丹","须弥","层岩巨渊","渊下宫","稻妻"],x=["雪山","璃月","蒙德"];for(let e of f){let t={lable:e,num:(b[this.area[e]]?.exploration_percentage??0)/10+"%"};_.push(t)}for(let e of x){let t={lable:e,num:(b[this.area[e]]?.exploration_percentage??0)/10+"%"};d.push(t)}d.push({lable:"家园等级",num:c}),h.push(_),h.push(d),s.length>0&&(s=a.chain(s).orderBy(["sortLevel"],["desc"]),this.e.msg.includes("角色")&&(s=s.slice(0,12)),s=s.orderBy(["sort"],["desc"]).value());let p=this.abyssAll(i,l);return{uid:this.e.uid,saveId:this.e.uid,activeDay:this.dayCount(u.active_day_number),line:h,basicInfo:n,avatars:s,abyss:p,headIndexStyle:this.headIndexStyle}}abyssAll(e,r){let n={};if(e.length<=0)return n;if(r?.total_battle_times<=0)return n;if(r?.reveal_rank.length<=0)return n;if(r?.floors.length<=2)return n;let s=l(r.startTime),i=Number(s.month())+1;s.day()>=15?i+="月下":i+="月上";let u=0,o=[];for(let e of r.floors)e.index<9||(u+=e.star,o.push(e.star));u=u+"（"+o.join("-")+"）";let m=["damage","take_damage","defeat","normal_skill","energy_skill"],h=[],c=[];for(let e of m)r[`${e}_rank`].length<=0&&(r[`${e}_rank`]=[{value:0,avatar_id:10000007}]),h[e]={num:r[`${e}_rank`][0].value,name:t.roleIdToName(r[`${e}_rank`][0].avatar_id)},h[e].num>1e3&&(h[e].num=(h[e].num/1e4).toFixed(1),h[e].num+=" w"),c.length<4&&!c.includes(r[`${e}_rank`][0].avatar_id)&&c.push(r[`${e}_rank`][0].avatar_id);let b=[],_=a.keyBy(e,"id");for(let e of r.reveal_rank)_[e.avatar_id]?e.life=_[e.avatar_id].actived_constellation_num:e.life=0,e.name=t.roleIdToName(e.avatar_id),b.push(e);return{time:i,max_floor:r.max_floor,totalStar:u,list:b,total_battle_times:r.total_battle_times,...h}}dayCount(e){let t=Math.floor((new Date-new Date("2020-09-15"))/864e5)+1;return"活跃天数："+Math.floor(e)+`/${t}天`}async roleCard(){this.model="roleCard";let e=await MysInfo.get(this.e,"index");return!(!e||0!==e.retcode)&&this.roleCardData(e.data)}roleCardData(e){this.initFile();let l=e.stats,r=[[{lable:"活跃天数",num:l.active_day_number},{lable:"成就",num:l.achievement_number},{lable:"角色数",num:l.avatar_number},{lable:"等级",num:e?.role?.level??0},{lable:"总宝箱",num:l.precious_chest_number+l.luxurious_chest_number+l.exquisite_chest_number+l.common_chest_number+l.magic_chest_number}],[{lable:"华丽宝箱",num:l.luxurious_chest_number},{lable:"珍贵宝箱",num:l.precious_chest_number},{lable:"精致宝箱",num:l.exquisite_chest_number},{lable:"普通宝箱",num:l.common_chest_number},{lable:"奇馈宝箱",num:l.magic_chest_number},{lable:"传送点",num:l.way_point_number}]],s=[],i=[];e.world_explorations=a.orderBy(e.world_explorations,["id"],["desc"]);for(let t of e.world_explorations){t.name=this.areaName[t.id]?this.areaName[t.id]:a.truncate(t.name,{length:6});let e={lable:t.name,num:t.exploration_percentage/10+"%"};s.length<5?s.push(e):i.push(e)}i=i.concat([{lable:"水神瞳",num:l.hydroculus_number},{lable:"草神瞳",num:l.dendroculus_number},{lable:"雷神瞳",num:l.electroculus_number},{lable:"岩神瞳",num:l.geoculus_number},{lable:"风神瞳",num:l.anemoculus_number},{lable:"秘境",num:l.domain_number}]),r.push(s),r.push(i.slice(0,5));let u=e.avatars;u=u.slice(0,8);let o=t.getdefSet("element","role");for(let e in u){10000005==u[e].id&&(u[e].name="空"),10000007==u[e].id&&(u[e].name="荧"),u[e].element=o[u[e].name];let t=n.get(u[e].name);u[e].img=t.imgs?.gacha}return{saveId:this.e.uid,uid:this.e.uid,name:this.e.sender.card.replace(this.e.uid,"").trim(),user_id:this.e.user_id,line:r,avatars:u,bg:a.random(1,3),...this.screenData}}async roleExplore(){this.model="roleExplore";let e=await MysInfo.get(this.e,{index:"",basicInfo:""});if(!e||0!==e[0].retcode)return!1;let t=[];return e.forEach((e=>t.push(e.data))),this.roleExploreData(t)}async roleExploreData(e){let[t,l]=e,r=t.stats,n=a.round(100*(r.precious_chest_number+r.luxurious_chest_number+r.exquisite_chest_number+r.common_chest_number+r.magic_chest_number)/this.all_chest,2),s=n<60?"D":(n<70?"C":n<80?"B":n<90?"A":"S")+`[${n}%]`,i=Math.floor((new Date-new Date("2020-09-15"))/864e5)+1,u=[[{lable:"角色数",num:r.avatar_number,extra:this.lable.avatar},{lable:"传送点",num:r.way_point_number,extra:this.lable.way_point},{lable:"秘境",num:r.domain_number,extra:this.lable.domain},{lable:"成就",num:r.achievement_number,extra:this.lable.achievement},{lable:"活跃天数",num:r.active_day_number,extra:`${i}`}],[{lable:"深境螺旋",num:r.spiral_abyss},{lable:"宝箱总数",num:r.precious_chest_number+r.luxurious_chest_number+r.exquisite_chest_number+r.common_chest_number+r.magic_chest_number,extra:this.all_chest},{lable:"宝箱获取率",num:s,color:"D"==s.substr(0,1)?"#12a182":"C"==s.substr(0,1)?"#2775b6":"B"==s.substr(0,1)?"#806d9e":"A"==s.substr(0,1)?"#c04851":"S"==s.substr(0,1)?"#f86b1d":""},{lable:"普通宝箱",num:r.common_chest_number,extra:this.lable.common_chest},{lable:"精致宝箱",num:r.exquisite_chest_number,extra:this.lable.exquisite_chest}],[{lable:"珍贵宝箱",num:r.precious_chest_number,extra:this.lable.precious_chest},{lable:"华丽宝箱",num:r.luxurious_chest_number,extra:this.lable.luxurious_chest},{lable:"奇馈宝箱",num:r.magic_chest_number,extra:this.lable.magic_chest},{lable:"风神瞳",num:r.anemoculus_number,extra:this.lable.anemoculus},{lable:"岩神瞳",num:r.geoculus_number,extra:this.lable.geoculus}],[{lable:"雷神瞳",num:r.electroculus_number,extra:this.lable.electroculus},{lable:"草神瞳",num:r.dendroculus_number,extra:this.lable.dendroculus},{lable:"水神瞳",num:r.hydroculus_number,extra:this.lable.hydroculus},{lable:"火神瞳",num:"待实装",extra:0},{lable:"冰神瞳",num:"待实装",extra:0}]];t.homes&&t.homes.length>0&&u.push([{lable:"家园等级",num:t.homes[0].level},{lable:"最高仙力",num:t.homes[0].comfort_num},{lable:"洞天名称",num:t.homes[0].comfort_level_name},{lable:"获得摆设",num:t.homes[0].item_num},{lable:"历史访客",num:t.homes[0].visit_num}]),t.world_explorations=a.orderBy(t.world_explorations,["id"],["desc"]);let o=[];for(let e of t.world_explorations){if([7,11,12,13].includes(e.id))continue;e.name=this.areaName[e.id]?this.areaName[e.id]:a.truncate(e.name,{length:6});let l={name:e.name,line:[{name:e.name,text:e.exploration_percentage/10+"%"}]};if(10==e.id&&(l.line=[]),["蒙德","璃月","稻妻","须弥","枫丹"].includes(e.name)&&l.line.push({name:"声望",text:`${e.level}级`}),[6,10].includes(e.id)){let r=[7];10==e.id&&(r=[13,12,11]);for(let e of r){let r=a.find(t.world_explorations,(function(t){return t.id==e}));r&&l.line.push({name:this.areaName[r.id],text:r.exploration_percentage/10+"%"})}}["雪山","稻妻","层岩巨渊","须弥","枫丹","沉玉谷"].includes(e.name)&&(e.offerings[0].name.includes("流明石")&&(e.offerings[0].name="流明石"),e.offerings[0].name.includes("露景泉")&&(e.offerings[0].name="露景泉"),"桓那兰那的梦之树"==e.offerings[0].name&&(e.offerings[0].name="梦之树"),l.line.push({name:e.offerings[0].name,text:`${e.offerings[0].level}级`})),o.push(l)}let m="";return m=this.e.member?.getAvatarUrl?await this.e.member.getAvatarUrl():this.e.friend?.getAvatarUrl?await this.e.friend.getAvatarUrl():t.role.game_head_icon,{saveId:this.e.uid,uid:this.e.uid,activeDay:this.dayCount(r.active_day_number),line:u,explor:o,basicInfo:l,headIndexStyle:this.headIndexStyle,...this.screenData,gamename:t?.role?.nickname??0,avatar:m,gameavatar:t?.role?.avatar??0,gamelevel:t?.role?.level??0,gamefwq:t?.role?.region}}headIndexStyle=void 0;initFile(){if(s["刻晴"])return s;let e="./plugins/genshin/resources/img/gacha/",t=r.readdirSync(e+"character/"),a=r.readdirSync(e+"weapon/"),l=e=>{let t=e.split(".");s[t[0]]=e};return t.forEach((e=>l(e))),a.forEach((e=>l(e))),s}}export{i as default};
