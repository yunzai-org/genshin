import e from"./base.js";import t from"lodash";import i from"node:fs";import*as a from"yunzai";import{NoteUser as s,gsCfg as l,MysUser as r,sequelize as o,UserGameDB as d}from"yunzai";import{promisify as n}from"node:util";import u from"yaml";import{Player as c,Data as k}from"../miao.js";class h extends e{constructor(e){super(e),this.model="bingCk",this.uidKey=`Yz:genshin:mys:qq-uid:${this.userId}`,this.allUid=[],this.e.isSr&&(this.uidKey=`Yz:srJson:mys:qq-uid:${this.userId}`)}async user(){return await s.create(this.e)}async resetCk(){let e=await this.user();await e.initCache()}async bing(){let e=await this.user(),i=l.getConfig("mys","set");if(this.ck&&!this.e.ck&&(this.e.ck=this.ck),!this.e.ck)return void await this.e.reply(`请【私聊】发送米游社Cookie，获取教程：\n${i.cookieDoc}`);let s=this.e.ck.replace(/#|'|"/g,""),o={};if(s.split(";").forEach((e=>{let i=t.trim(e).replace("=","~").split("~");o[i[0]]=i[1]})),!o.cookie_token&&!o.cookie_token_v2)return void await this.e.reply("发送Cookie不完整\n请退出米游社【重新登录】，刷新完整Cookie");let d=await r.create(o.ltuid||o.ltuid_v2||o.account_id_v2||o.ltmid_v2);if(!d)return void await this.e.reply("发送Cookie不完整或数据错误");let n={};n.ck=`ltoken=${o.ltoken};ltuid=${o.ltuid||o.login_uid};cookie_token=${o.cookie_token||o.cookie_token_v2}; account_id=${o.ltuid||o.login_uid};`;let u=!1;if(o.cookie_token_v2&&(o.account_mid_v2||o.ltmid_v2)&&(u=!0,n.ck=`ltuid=${o.ltuid||o.login_uid||o.ltuid_v2};account_mid_v2=${o.account_mid_v2};cookie_token_v2=${o.cookie_token_v2};ltoken_v2=${o.ltoken_v2};ltmid_v2=${o.ltmid_v2};`),o.mi18nLang&&(n.ck+=` mi18nLang=${o.mi18nLang};`),n.ltuid=o.ltuid||o.ltuid_v2||o.account_id_v2||o.ltmid_v2,n.login_ticket=o.login_ticket??"",d.setCkData(n),0!==(await d.reqMysUid()).status)return logger.mark(`绑定Cookie错误1：${this.checkMsg||"Cookie错误"}`),d._delCache(),await this.e.reply(`绑定Cookie失败：${this.checkMsg||"Cookie错误"}`);if(u&&isNaN(n.ltuid)){let e=await d.getUserFullInfo();if(!e?.data?.user_info)return logger.mark(`绑定Cookie错误2：${e.message||"Cookie错误"}`),await this.e.reply(`绑定Cookie失败：${e.message||"Cookie错误"}`);{let t=e?.data?.user_info;this.ltuid=t.uid||this.ltuid,this.ck=`${this.ck}ltuid=${this.ltuid};`}}logger.mark(`${this.e.logFnc} 检查Cookie正常 [ltuid:${d.ltuid}]`),await e.addMysUser(d),await d.initCache(),await e.save(),logger.mark(`${this.e.logFnc} 保存Cookie成功 [ltuid:${d.ltuid}]`);let c=["绑定Cookie成功",d.getUidInfo()];await this.e.reply(c.join("\n"));let k=[],h=[];d.hasGame("gs")&&(k.push("原神模块支持：","【#uid】当前绑定ck uid列表","【#我的ck】查看当前绑定ck","【#删除ck】删除当前绑定ck","【#体力】查询当前树脂","【#原石】查看原石札记","【#原石统计】原石统计数据","【#练度统计】角色列表数据","【#面板】【#更新面板】面板信息"),h.push([{text:"#uid",callback:"#uid"},{text:"#我的ck",callback:"#我的ck"},{text:"#删除ck",callback:"#删除ck"}],[{text:"#体力",callback:"#体力"},{text:"#原石",callback:"#原石"},{text:"#原石统计",callback:"#原石统计"}],[{text:"#练度统计",callback:"#练度统计"},{text:"#面板",callback:"#面板"},{text:"#更新面板",callback:"#更新面板"}])),d.hasGame("sr")&&(k.push("星穹铁道支持：","【*uid】当前绑定ck uid列表","【*删除ck】删除当前绑定ck","【*体力】查询当前开拓力","【*星琼】查看星琼月历","【*星琼统计】星琼统计数据","【*练度统计】角色列表数据","【*面板】【*更新面板】面板信息"),h.push([{text:"*uid",callback:"*uid"},{text:"*删除ck",callback:"*删除ck"},{text:"*体力",callback:"*体力"}],[{text:"*星琼",callback:"*星琼"},{text:"*星琼统计",callback:"*星琼统计"},{text:"*练度统计",callback:"*练度统计"}],[{text:"*面板",callback:"*面板"},{text:"*更新面板",callback:"*更新面板"}])),k=await a.makeForwardMsg(this.e,[[k.join("\n"),segment.button(...h)]],"绑定成功：使用命令说明"),await this.e.reply(k)}async delCk(){let e;e=this.e.game?this.e.game:"gs";let t=await this.user(),i=t.getUidData("",e,this.e);if(!i||"ck"!==i.type||!i.ltuid)return`删除失败：当前的UID${i?.uid}无CK信息`;let a=await r.create(i.ltuid);if(!a)return`删除失败：当前的UID${i?.uid}无CK信息`;let s=["绑定Cookie已删除",a.getUidInfo()];return await t.delMysUser(i.ltuid),s.join("\n")}async bingUid(){let e=this.e.msg.match(/([1-9]|18)[0-9]{8}/g);if(!e)return;e=e[0];let t=await this.user();return await t.addRegUid(e,this.e),await this.showUid()}async delUid(e){let t=await this.user(),i=this.e,a=t.getUidList(i);if(e>a.length)return await this.e.reply(["uid序号输入错误",segment.button([{text:"删除uid",input:"#删除uid"}])]);let s=a[e=Number(e)-1];return"ck"===s.type?await this.e.reply(["CK对应UID无法直接删除，请通过【#删除ck】命令来删除",segment.button([{text:"删除ck",callback:"#删除ck"}])]):(await t.delRegUid(s.uid,i),await this.showUid())}async showUid_bak(){let e=await this.user(),i=[],a={ck:"CK Uid",reg:"绑定 Uid"};t.forEach({gs:"原神 (#uid)",sr:"星穹铁道 (*uid)"},((s,l)=>{let r=e.getUidList(l),o=e.getUid(l);if(i.push(`【${s}】`),0===r.length)return i.push(`暂无，通过${"gs"===l?"#":"*"}绑定123456789来绑定UID`),!0;t.forEach(r,((e,t)=>{let s=`${++t}: ${e.uid} (${a[e.type]})`;1*o==1*e.uid&&(s+=" ☑"),i.push(s)}))})),i.unshift("通过【#uid+序号】来切换uid，【#删除uid+序号】删除uid"),await this.e.reply(i.join("\n"))}async showUid(){let e=await this.user(),i=[{key:"gs",name:"原神"},{key:"sr",name:"星穹铁道"}];t.forEach(i,(i=>{i.uidList=e.getUidList(i.key),i.uid=e.getUid(i.key),t.forEach(i.uidList,(e=>{let t=c.create(e.uid,i.key);if(t){e.name=t.name,e.level=t.level;let i=t?.faceImgs||{};e.face=i.face,e.banner=i.banner}}))}));const a=segment.image(await this.e.runtime.render("genshin","html/user/uid-list",{uids:i}));return this.e.reply([a,segment.button([{text:"绑定UID",input:"#绑定uid"},{text:"切换UID",input:"#uid"},{text:"删除UID",input:"#删除uid"}],[{text:"角色",callback:"#角色"},{text:"探索",callback:"#探索"},{text:"武器",callback:"#武器"},{text:"深渊",callback:"#深渊"}],[{text:"统计",callback:"#练度统计"},{text:"面板",callback:"#面板"},{text:"体力",callback:"#体力"},{text:"原石",callback:"#原石"}],[{text:"留影",callback:"#留影叙佳期"},{text:"七圣",callback:"#七圣召唤查询牌组"},{text:"抽卡",callback:"#抽卡记录"},{text:"充值",callback:"#充值记录"}])])}async toggleUid(e){let t=await this.user(),i=this.e;return e>t.getUidList(i).length?await this.e.reply(["uid序号输入错误",segment.button([{text:"切换uid",input:"#uid"}])]):(e=Number(e)-1,t.setMainUid(e,i),await t.save(),await this.showUid())}async loadOldDataV2(){let e=["./data/MysCookie/NoteCookie.json","./data/NoteCookie/NoteCookie.json","./data/NoteCookie.json"].find((e=>i.existsSync(e)));if(!e)return;let a=JSON.parse(i.readFileSync(e,"utf8")),s={};logger.mark(logger.green("加载用户ck...")),t.forEach(a,((e,i)=>{e.qq&&(i=e.qq);let a=!1;s[i]||(s[i]={},a=!0);let l={};e.cookie.split(";").forEach((e=>{let i=t.trim(e).split("=");l[i[0]]=i[1]}));let r=l.ltuid;l.cookie_token&&(s[i][String(e.uid)]={uid:e.uid,qq:i,ck:e.cookie,ltuid:r,isMain:a})}));let l=await this.loadOldData(s);l>0&&logger.mark(logger.green(`DB导入V2用户ck${l}个`)),i.unlinkSync(e)}async loadOldDataV3(){let e="./data/MysCookie/";if(!i.existsSync(e))return!1;k.createDir("./temp/MysCookieBak");let t=i.readdirSync(e).filter((e=>e.endsWith(".yaml")));const a=n(i.readFile);let s=[];if(0===t.length)return void i.rmdirSync("./data/MysCookie/");t.forEach((t=>s.push(a(`${e}${t}`,"utf8"))));const l=await Promise.all(s);let r={};for(let e of l){let t;e=u.parse(e);for(let i in e)t=t||e[i]?.qq;t&&(r[t]=e)}let o=await this.loadOldData(r);o>0&&logger.mark(logger.green(`DB导入V3用户ck${o}个`))}async loadOldUid(){await o.query("delete from UserGames where userId is null or data is null",{});let e=await d.findAll();await k.forEach(e,(async e=>{if(!e.userId)return e.destroy(),!0;let i=await s.create(e.userId);e.userId&&e.data&&t.forEach(e.data,(t=>{let{uid:a}=t;i.addRegUid(a,e.game,!1)})),e.uid&&i.setMainUid(e.uid,e.game,!1),await i.save(),await e.destroy()}));let i=await redis.keys("Yz:genshin:mys:qq-uid:*");for(let e of i){let t=await redis.get(e),i=/Yz:genshin:mys:qq-uid:(\d{5,12})/.exec(e);if(i?.[1]&&t){let e=await s.create(i[1]);e.getUid("gs")||e.addRegUid(t,"gs")}redis.del(e)}await o.query("delete from Users where (ltuids is null or ltuids='') and games is null",{}),console.log("load Uid Data Done...")}async loadOldData(e){if(t.isPlainObject(e))for(let t in e){let a,l={},o=e[t];for(let e in o){let t=o[e];a=a||t?.qq;let{uid:i,ck:s,ltuid:r,region_name:d,device_id:n}=t;l[r]=l[r]||{ck:s,device:n,ltuid:r,uids:{},type:/America Server|Europe Server|Asia Server/.test(d)?"hoyolab":"mys"};let u=l[r],c="星穹列车"===d?"sr":"gs";u.uids[c]=u.uids[c]||[];let k=u.uids[c];k.includes(i+"")||k.push(i+"")}if(!a)continue;let d=await s.create(a);for(let e in l){let t=l[e],i=await r.create(t.ltuid);i&&(i.setCkData(t),await i.save(),d.addMysUser(i))}if(await d.save(),i.existsSync(`./data/MysCookie/${a}.yaml`))try{let e=`./data/MysCookie/${a}.yaml`,t=`./temp/MysCookieBak/${a}.yaml`;await i.promises.unlink(t).catch((e=>{})),await i.promises.copyFile(e,t),await i.promises.unlink(e)}catch(e){console.log(e)}}}async myCk(){let e=await this.user();e.hasCk||this.e.reply(["当前尚未绑定Cookie",segment.button([{text:"帮助",input:"#Cookie帮助"}])]);let t=e.getMysUser(this.e);t&&(await this.e.reply(`当前绑定Cookie\nuid：${t.getUid(this.e)}`),await this.e.reply(t.ck))}async checkCkStatus(){let e=await this.user();if(!e.hasCk)return await this.e.reply(`\n未绑定CK，当前绑定uid：${e.uid||"无"}`,!1,{at:!0}),!0;let i=1*e.uid,a=e.ckUids,s=await e.checkCk(),l=[];t.forEach(s,((e,a)=>{let s=[`\n#${a+1}: [CK:${e.ltuid}] - 【${0===e.status?"正常":"失效"}】`];if(e.uids&&e.uids.length>0){let a=[];t.forEach(e.uids,(e=>{a.push(1*e===i?`☑${e}`:e)})),s.push(`绑定UID: [ ${a.join(", ")} ]`)}0!==e.status&&s.push(e.msg),l.push(s.join("\n"))})),a.length>1&&l.push(`当前生效uid：${i}\n通过【#uid】命令可查看并切换UID`),await this.e.reply([l.join("\n----\n"),segment.button([{text:"绑定UID",input:"#绑定uid"},{text:"切换UID",input:"#uid"},{text:"删除UID",input:"#删除uid"}])],!1,{at:!0})}async userAdmin(){return this.model="userAdmin",await MysInfo.initCache(),{saveId:"user-admin",...await r.getStatData(),_plugin:"genshin",...this.screenData}}async bindNoteUser(){let e=(await this.user()).qq,{e:t}=this,{msg:i,mainUserId:a,originalUserId:s}=t;if(!e)return!0;if(/(删除绑定|取消绑定|解除绑定|解绑|删除|取消)/.test(i)){if(e=s||e,/主/.test(i)){let i=await redis.get(`Yz:NoteUser:mainId:${e}`);if(!i)return t.reply("当前用户没有主用户，在主用户中通过【#绑定用户】可进行绑定..."),!0;let a=await k.getCacheJSON(`Yz:NoteUser:subIds:${i}`);delete a[e],await redis.del(`Yz:NoteUser:mainId:${e}`),await k.setCacheJSON(`Yz:NoteUser:subIds:${i}`,a),t.reply("已经解除与主用户的绑定...")}else if(/子/.test(i)){let i=await k.getCacheJSON(`Yz:NoteUser:subIds:${e}`),a=0;for(let e in i)await redis.del(`Yz:NoteUser:mainId:${e}`),a++;a>0?(t.reply(`已删除${a}个子用户...`),await redis.del(`Yz:NoteUser:subIds:${e}`)):t.reply("当前用户没有子用户，通过【#绑定用户】可绑定子用户...")}return!0}i=i.replace(/^#\s*(接受)?绑定(主|子)?(用户|账户|账号)/,"");let l=/^\[([a-zA-Z0-9-]{5,})](?:\[([a-zA-Z0-9-]+)])?$/.exec(i);if(l&&l[1]){let i=l[1],r=e.toString();if(l[2]){if(r!==i)return t.reply("请切换到主用户并发送接受绑定的命令..."),!0;let e=await redis.get(`Yz:NoteUser:verify:${i}`)||"";if(e=e.split("||"),!e||e[0]!==l[2]||!e[1])return t.reply("校验失败，请发送【#绑定用户】重新开始绑定流程"),await redis.del(`Yz:NoteUser:verify:${i}`),!0;let a=e[1];await redis.del(`Yz:NoteUser:verify:${i}`),await redis.set(`Yz:NoteUser:mainId:${a}`,i,{EX:31536e3});let s=await k.getCacheJSON(`Yz:NoteUser:subIds:${i}`);return s[a]="true",await k.setCacheJSON(`Yz:NoteUser:subIds:${i}`,s),t.reply("绑定成功，绑定的子用户可使用主用户的UID/CK等信息\n请勿接受不是自己用户的绑定，如需解绑可通过【#解绑子用户】进行解绑"),!0}{if(r===i)return s&&s!==i&&a===i?t.reply("当前账户已完成绑定..."):t.reply("请切换到需要绑定的子用户并发送绑定命令..."),!0;let e=Math.floor(1e8+1e8*Math.random()).toString();return await redis.set(`Yz:NoteUser:verify:${i}`,e+"||"+r,{EX:300}),t.reply([`此账号将作为子用户，绑定至主用户:${i}`,"成功绑定后，此用户输入的命令，将视作主用户命令，使用主用户的CK与UID等信息","如需继续绑定，请在5分钟内，使用主账户发送以下命令：","",`#接受绑定子用户[${i}][${e}]`].join("\n")),!0}}if(a&&s&&s!==a)return t.reply("当前账户已有绑定的主账户，请使用主账户发起绑定..."),!0;t.reply(["将此账号作为【主用户】，绑定其他子用户。","","可在多个QQ或频道间打通用户信息，子用户会使用主用户的CK与UID等信息","注意：请勿接受不是自己用户的绑定！","请【切换至需要绑定的子用户】并发送以下命令，获得验证命令...","",`#绑定主用户[${e}]`].join("\n"))}}export{h as default};
